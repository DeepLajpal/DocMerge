<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DocMerge — PDF & Image Merger</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,300;0,400;0,600;0,700;1,300&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --ink: #1a1a2e;
    --ink-soft: #4a4a6a;
    --ink-muted: #8888aa;
    --paper: #f7f6f2;
    --paper-warm: #eeeae0;
    --surface: #ffffff;
    --accent: #c84b31;
    --accent-soft: #f5ede9;
    --accent-mid: #e8705a;
    --teal: #2a7f7f;
    --teal-soft: #e6f3f3;
    --gold: #c9a84c;
    --gold-soft: #faf5e8;
    --border: #ddd9ce;
    --shadow-sm: 0 2px 8px rgba(26,26,46,0.07);
    --shadow-md: 0 4px 24px rgba(26,26,46,0.10);
    --shadow-lg: 0 8px 40px rgba(26,26,46,0.13);
    --radius: 14px;
    --radius-sm: 8px;
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background texture */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      radial-gradient(ellipse at 20% 10%, rgba(200,75,49,0.06) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 90%, rgba(42,127,127,0.06) 0%, transparent 50%),
      url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231a1a2e' fill-opacity='0.018'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  .app-wrap {
    position: relative;
    z-index: 1;
    max-width: 960px;
    margin: 0 auto;
    padding: 40px 24px 80px;
  }

  /* Header */
  header {
    display: flex;
    align-items: flex-end;
    gap: 16px;
    margin-bottom: 40px;
  }

  .logo-mark {
    width: 52px;
    height: 52px;
    background: var(--ink);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
  }
  .logo-mark::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, var(--accent) 0%, var(--ink) 60%);
  }
  .logo-mark svg { position: relative; z-index: 1; }

  .logo-text h1 {
    font-family: 'Fraunces', serif;
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: -0.03em;
    line-height: 1;
    color: var(--ink);
  }
  .logo-text p {
    font-size: 0.82rem;
    color: var(--ink-muted);
    margin-top: 4px;
    font-weight: 400;
    letter-spacing: 0.02em;
  }

  .header-badge {
    margin-left: auto;
    background: var(--accent-soft);
    color: var(--accent);
    font-size: 0.72rem;
    font-weight: 600;
    padding: 5px 10px;
    border-radius: 20px;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    border: 1px solid rgba(200,75,49,0.2);
  }

  /* Layout grid */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 20px;
    align-items: start;
  }
  @media (max-width: 768px) {
    .main-grid { grid-template-columns: 1fr; }
  }

  /* Cards */
  .card {
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }

  .card-header {
    padding: 18px 22px 14px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .card-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .card-icon.red { background: var(--accent-soft); color: var(--accent); }
  .card-icon.teal { background: var(--teal-soft); color: var(--teal); }
  .card-icon.gold { background: var(--gold-soft); color: var(--gold); }
  .card-icon.ink { background: rgba(26,26,46,0.07); color: var(--ink); }

  .card-title {
    font-family: 'Fraunces', serif;
    font-size: 1rem;
    font-weight: 600;
    color: var(--ink);
    letter-spacing: -0.01em;
  }

  .card-body { padding: 20px 22px; }

  /* Drop zone */
  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: var(--radius-sm);
    padding: 44px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    background: var(--paper);
    position: relative;
  }
  .drop-zone:hover, .drop-zone.drag-over {
    border-color: var(--accent);
    background: var(--accent-soft);
  }
  .drop-zone.drag-over { transform: scale(1.01); }

  .drop-icon {
    width: 56px;
    height: 56px;
    margin: 0 auto 14px;
    background: var(--surface);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
  }

  .drop-zone h3 {
    font-family: 'Fraunces', serif;
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--ink);
    margin-bottom: 6px;
  }
  .drop-zone p {
    font-size: 0.82rem;
    color: var(--ink-muted);
    margin-bottom: 16px;
  }

  .btn-select {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    background: var(--ink);
    color: white;
    padding: 9px 20px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.18s;
    font-family: 'DM Sans', sans-serif;
  }
  .btn-select:hover { background: var(--accent); transform: translateY(-1px); box-shadow: var(--shadow-sm); }

  .format-tags {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-top: 14px;
  }
  .format-tag {
    font-size: 0.7rem;
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .format-tag.pdf { background: rgba(200,75,49,0.1); color: var(--accent); }
  .format-tag.jpg { background: rgba(42,127,127,0.1); color: var(--teal); }
  .format-tag.png { background: rgba(201,168,76,0.1); color: var(--gold); }

  /* file-item styles defined in the order/pagination section above */
  #file-list-section { display: none; }
  #file-list-section.visible { display: block; }

  .drag-handle {
    color: var(--ink-muted);
    cursor: grab;
    flex-shrink: 0;
    padding: 2px;
  }

  .file-type-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 0.6rem;
    font-weight: 700;
    letter-spacing: 0.05em;
  }
  .file-type-icon.pdf { background: var(--accent-soft); color: var(--accent); }
  .file-type-icon.img { background: var(--teal-soft); color: var(--teal); }

  .file-info { flex: 1; min-width: 0; }
  .file-name {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--ink);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .file-meta {
    font-size: 0.73rem;
    color: var(--ink-muted);
    margin-top: 2px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .page-count {
    background: var(--accent-soft);
    color: var(--accent);
    padding: 1px 7px;
    border-radius: 3px;
    font-size: 0.68rem;
    font-weight: 600;
  }

  /* ── Password lock button (inline in file row) ── */
  .btn-lock {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 9px 3px 7px;
    border-radius: 20px;
    border: 1.5px solid;
    font-size: 0.7rem;
    font-weight: 700;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s ease;
    white-space: nowrap;
    position: relative;
    overflow: hidden;
    letter-spacing: 0.02em;
  }
  .btn-lock::before {
    content: '';
    position: absolute; inset: 0;
    background: currentColor;
    opacity: 0;
    transition: opacity 0.15s;
  }
  .btn-lock:hover::before { opacity: 0.07; }
  .btn-lock:active { transform: scale(0.96); }

  /* Locked state */
  .btn-lock.lock-locked {
    background: #fef3c7;
    color: #92400e;
    border-color: #fcd34d;
  }
  .btn-lock.lock-locked:hover {
    background: #fde68a;
    border-color: #f59e0b;
    box-shadow: 0 2px 8px rgba(217,119,6,0.2);
  }

  /* Unlocked state */
  .btn-lock.lock-unlocked {
    background: #dcfce7;
    color: #15803d;
    border-color: #86efac;
  }
  .btn-lock.lock-unlocked:hover {
    background: #bbf7d0;
    border-color: #4ade80;
    box-shadow: 0 2px 8px rgba(22,163,74,0.2);
  }

  /* Error state */
  .btn-lock.lock-error {
    background: #fff1f2;
    color: #b91c1c;
    border-color: #fca5a5;
    animation: btn-lock-shake 0.4s ease;
  }
  @keyframes btn-lock-shake {
    0%,100% { transform: translateX(0); }
    20%     { transform: translateX(-3px); }
    40%     { transform: translateX(3px); }
    60%     { transform: translateX(-2px); }
    80%     { transform: translateX(2px); }
  }
  .btn-lock.lock-error:hover {
    background: #fee2e2;
    border-color: #f87171;
  }

  /* Verifying state */
  .btn-lock.lock-verifying {
    background: #fff7ed;
    color: #9a3412;
    border-color: #fdba74;
    cursor: wait;
  }

  /* Lock SVG inside button — animated shackle */
  .btn-lock-svg {
    width: 13px; height: 13px;
    overflow: visible;
    flex-shrink: 0;
  }
  .btn-lock-shackle {
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), stroke 0.3s;
    transform-origin: 50% 55%;
  }
  .btn-lock-body { transition: fill 0.3s, stroke 0.3s; }
  .btn-lock-keyhole { transition: opacity 0.25s; }

  .btn-lock.lock-locked   .btn-lock-shackle { transform: rotate(0deg); stroke: #d97706; }
  .btn-lock.lock-locked   .btn-lock-body    { fill: #fef3c7; stroke: #d97706; }
  .btn-lock.lock-locked   .btn-lock-keyhole { opacity: 1; fill: #d97706; }

  .btn-lock.lock-unlocked .btn-lock-shackle { transform: rotate(-50deg) translate(-1px,-2px); stroke: #16a34a; }
  .btn-lock.lock-unlocked .btn-lock-body    { fill: #dcfce7; stroke: #16a34a; }
  .btn-lock.lock-unlocked .btn-lock-keyhole { opacity: 0; }

  .btn-lock.lock-error    .btn-lock-shackle { transform: rotate(0deg); stroke: #dc2626; }
  .btn-lock.lock-error    .btn-lock-body    { fill: #fff1f2; stroke: #dc2626; }
  .btn-lock.lock-error    .btn-lock-keyhole { opacity: 1; fill: #dc2626; }

  .btn-lock.lock-verifying .btn-lock-shackle { stroke: #ea580c; animation: shackle-jiggle 0.5s ease-in-out infinite alternate; }
  .btn-lock.lock-verifying .btn-lock-body    { fill: #fff7ed; stroke: #ea580c; }
  .btn-lock.lock-verifying .btn-lock-keyhole { opacity: 1; fill: #ea580c; }
  @keyframes shackle-jiggle {
    0%   { transform: rotate(-6deg) translateY(-1px); }
    100% { transform: rotate(6deg)  translateY(-1px); }
  }

  /* ── Password popup modal ── */
  #pw-modal-root { display: none; position: fixed; inset: 0; z-index: 1200; align-items: center; justify-content: center; }
  #pw-modal-root.open { display: flex; animation: fadeIn 0.18s ease; }
  .pw-modal-backdrop { position: absolute; inset: 0; background: rgba(10,10,20,0.5); backdrop-filter: blur(4px); cursor: pointer; }
  .pw-modal {
    background: var(--surface);
    border-radius: 18px;
    width: min(400px, 92vw);
    box-shadow: 0 24px 64px rgba(0,0,0,0.25), 0 0 0 1px rgba(0,0,0,0.06);
    overflow: hidden;
    position: relative; z-index: 1;
    animation: pwModalIn 0.28s cubic-bezier(0.34,1.56,0.64,1);
  }
  @keyframes pwModalIn {
    from { transform: scale(0.82) translateY(16px); opacity: 0; }
    to   { transform: scale(1) translateY(0);        opacity: 1; }
  }

  /* Modal top accent bar — color changes by state */
  .pw-modal-bar {
    height: 4px;
    transition: background 0.4s ease;
  }
  .pw-modal.state-locked   .pw-modal-bar { background: linear-gradient(90deg, #fcd34d, #f59e0b); }
  .pw-modal.state-typing   .pw-modal-bar { background: linear-gradient(90deg, #fb923c, #ea580c); }
  .pw-modal.state-unlocked .pw-modal-bar { background: linear-gradient(90deg, #4ade80, #16a34a); }
  .pw-modal.state-error    .pw-modal-bar { background: linear-gradient(90deg, #fca5a5, #dc2626); }
  .pw-modal.state-verifying .pw-modal-bar { background: linear-gradient(90deg, #fdba74, #ea580c); background-size: 200%; animation: bar-slide 1s linear infinite; }
  @keyframes bar-slide { 0% { background-position: 0%; } 100% { background-position: 200%; } }

  .pw-modal-inner { padding: 24px 24px 20px; }

  /* Big centered lock animation */
  .pw-modal-lock-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }
  .pw-modal-lock-ring {
    width: 64px; height: 64px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.4s ease, box-shadow 0.4s ease;
    position: relative;
  }
  .pw-modal.state-locked    .pw-modal-lock-ring { background: #fef9c3; box-shadow: 0 0 0 8px rgba(253,230,138,0.3); }
  .pw-modal.state-typing    .pw-modal-lock-ring { background: #fff7ed; box-shadow: 0 0 0 8px rgba(254,215,170,0.3); }
  .pw-modal.state-unlocked  .pw-modal-lock-ring { background: #dcfce7; box-shadow: 0 0 0 8px rgba(187,247,208,0.35); }
  .pw-modal.state-error     .pw-modal-lock-ring { background: #fff1f2; box-shadow: 0 0 0 8px rgba(254,202,202,0.35); }
  .pw-modal.state-verifying .pw-modal-lock-ring { background: #fff7ed; box-shadow: 0 0 0 8px rgba(254,215,170,0.3), 0 0 0 14px rgba(254,215,170,0.15); }

  .pw-modal-lock-svg {
    width: 34px; height: 34px;
    overflow: visible;
  }
  .modal-lock-shackle {
    transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), stroke 0.35s;
    transform-origin: 50% 58%;
  }
  .modal-lock-body    { transition: fill 0.35s, stroke 0.35s; }
  .modal-lock-keyhole { transition: opacity 0.3s; }

  .pw-modal.state-locked    .modal-lock-shackle { transform: rotate(0deg); stroke: #d97706; }
  .pw-modal.state-locked    .modal-lock-body    { fill: #fef3c7; stroke: #d97706; }
  .pw-modal.state-locked    .modal-lock-keyhole { opacity: 1; fill: #d97706; }

  .pw-modal.state-typing    .modal-lock-shackle { stroke: #ea580c; animation: modal-shackle-jiggle 0.5s ease-in-out infinite alternate; }
  .pw-modal.state-typing    .modal-lock-body    { fill: #fff7ed; stroke: #ea580c; }
  .pw-modal.state-typing    .modal-lock-keyhole { opacity: 1; fill: #ea580c; }
  @keyframes modal-shackle-jiggle {
    0%   { transform: rotate(-12deg) translateY(-2px); }
    100% { transform: rotate(12deg)  translateY(-2px); }
  }

  .pw-modal.state-unlocked  .modal-lock-shackle { transform: rotate(-50deg) translate(-2px, -4px); stroke: #16a34a; }
  .pw-modal.state-unlocked  .modal-lock-body    { fill: #dcfce7; stroke: #16a34a; }
  .pw-modal.state-unlocked  .modal-lock-keyhole { opacity: 0; }

  .pw-modal.state-error     .modal-lock-shackle { transform: rotate(0deg); stroke: #dc2626; }
  .pw-modal.state-error     .modal-lock-body    { fill: #fff1f2; stroke: #dc2626; animation: modal-lock-shake 0.4s ease; }
  .pw-modal.state-error     .modal-lock-keyhole { opacity: 1; fill: #dc2626; }
  @keyframes modal-lock-shake {
    0%,100% { transform: translateX(0); }
    20%     { transform: translateX(-5px) rotate(-4deg); }
    40%     { transform: translateX(5px)  rotate(4deg); }
    60%     { transform: translateX(-4px) rotate(-3deg); }
    80%     { transform: translateX(4px)  rotate(3deg); }
  }

  .pw-modal.state-verifying .modal-lock-shackle { stroke: #ea580c; animation: modal-shackle-jiggle 0.4s ease-in-out infinite alternate; }
  .pw-modal.state-verifying .modal-lock-body    { fill: #fff7ed; stroke: #ea580c; }
  .pw-modal.state-verifying .modal-lock-keyhole { opacity: 1; fill: #ea580c; }

  .pw-modal-title {
    font-family: 'Fraunces', serif;
    font-size: 1.05rem;
    font-weight: 700;
    text-align: center;
    transition: color 0.3s;
    line-height: 1.2;
  }
  .pw-modal-sub {
    font-size: 0.76rem;
    text-align: center;
    color: var(--ink-muted);
    margin-top: 4px;
    line-height: 1.4;
    transition: color 0.3s;
  }

  .pw-modal.state-locked    .pw-modal-title { color: #92400e; }
  .pw-modal.state-typing    .pw-modal-title { color: #9a3412; }
  .pw-modal.state-unlocked  .pw-modal-title { color: #15803d; }
  .pw-modal.state-error     .pw-modal-title { color: #b91c1c; }
  .pw-modal.state-verifying .pw-modal-title { color: #9a3412; }

  /* File name chip */
  .pw-modal-filename {
    display: flex; align-items: center; gap: 7px;
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 7px 11px;
    margin-bottom: 16px;
    overflow: hidden;
  }
  .pw-modal-filename span {
    font-size: 0.78rem;
    color: var(--ink-soft);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 500;
  }

  /* Input wrapper */
  .pw-modal-input-wrap {
    position: relative;
    margin-bottom: 6px;
  }
  .pw-modal-input {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 11px 44px 11px 14px;
    font-size: 0.88rem;
    font-family: 'DM Sans', sans-serif;
    color: var(--ink);
    background: var(--paper);
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s, background 0.3s;
    letter-spacing: 0.05em;
  }
  .pw-modal.state-locked    .pw-modal-input { border-color: #fcd34d; }
  .pw-modal.state-locked    .pw-modal-input:focus { border-color: #f59e0b; box-shadow: 0 0 0 3px rgba(245,158,11,0.14); }
  .pw-modal.state-typing    .pw-modal-input { border-color: #fb923c; background: #fff7ed; }
  .pw-modal.state-typing    .pw-modal-input:focus { border-color: #ea580c; box-shadow: 0 0 0 3px rgba(234,88,12,0.12); }
  .pw-modal.state-unlocked  .pw-modal-input { border-color: #4ade80; background: #f0fdf4; color: #15803d; font-weight: 500; }
  .pw-modal.state-error     .pw-modal-input { border-color: #f87171; background: #fff1f2; animation: modal-input-shake 0.35s ease; }
  .pw-modal.state-verifying .pw-modal-input { border-color: #fdba74; background: #fff7ed; pointer-events: none; }
  @keyframes modal-input-shake {
    0%,100% { transform: translateX(0); }
    25%     { transform: translateX(-6px); }
    75%     { transform: translateX(6px); }
  }

  .pw-modal-eye {
    position: absolute; right: 12px; top: 50%;
    transform: translateY(-50%);
    background: none; border: none; cursor: pointer;
    color: var(--ink-muted); padding: 4px;
    border-radius: 4px;
    display: flex; align-items: center;
    transition: color 0.15s;
  }
  .pw-modal-eye:hover { color: var(--ink); }
  .pw-modal.state-unlocked .pw-modal-eye { color: #16a34a; }
  .pw-modal.state-error    .pw-modal-eye { color: #dc2626; }
  .pw-eye-open  { display: block; }
  .pw-eye-shut  { display: none; }
  .pw-modal-eye.showing .pw-eye-open { display: none; }
  .pw-modal-eye.showing .pw-eye-shut { display: block; }

  /* Strength dots */
  .pw-modal-dots {
    display: flex; gap: 4px; margin-top: 8px; margin-bottom: 2px;
  }
  .pw-modal-dot {
    flex: 1; height: 3px; border-radius: 2px;
    background: var(--border);
    transition: background 0.25s ease;
  }
  .pw-modal-dot.weak   { background: #ef4444; }
  .pw-modal-dot.medium { background: #f59e0b; }
  .pw-modal-dot.strong { background: #22c55e; }

  /* Status message */
  .pw-modal-status {
    font-size: 0.74rem;
    min-height: 18px;
    margin-top: 6px;
    display: flex; align-items: center; gap: 5px;
    transition: color 0.2s;
  }
  .pw-modal.state-error     .pw-modal-status { color: #b91c1c; }
  .pw-modal.state-unlocked  .pw-modal-status { color: #15803d; }
  .pw-modal.state-verifying .pw-modal-status { color: #9a3412; }
  .pw-modal.state-typing    .pw-modal-status { color: var(--ink-muted); }
  .pw-modal.state-locked    .pw-modal-status { color: var(--ink-muted); }

  /* Action buttons */
  .pw-modal-actions {
    display: flex; gap: 10px; margin-top: 18px;
  }
  .btn-pw-cancel {
    flex: 1;
    padding: 10px;
    background: var(--paper); color: var(--ink-soft);
    border: 1.5px solid var(--border); border-radius: 10px;
    font-size: 0.85rem; font-weight: 500;
    font-family: 'DM Sans', sans-serif; cursor: pointer;
    transition: all 0.15s;
  }
  .btn-pw-cancel:hover { border-color: var(--ink-muted); color: var(--ink); }

  .btn-pw-unlock {
    flex: 2;
    padding: 10px 16px;
    border: none; border-radius: 10px;
    font-size: 0.88rem; font-weight: 700;
    font-family: 'DM Sans', sans-serif; cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 7px;
    transition: all 0.2s ease;
    position: relative; overflow: hidden;
  }
  .btn-pw-unlock::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.15), transparent);
  }
  /* locked / typing → amber unlock button */
  .pw-modal.state-locked    .btn-pw-unlock,
  .pw-modal.state-typing    .btn-pw-unlock { background: #d97706; color: white; }
  .pw-modal.state-locked    .btn-pw-unlock:hover,
  .pw-modal.state-typing    .btn-pw-unlock:hover { background: #b45309; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(180,83,9,0.35); }
  /* error → red */
  .pw-modal.state-error     .btn-pw-unlock { background: #dc2626; color: white; }
  .pw-modal.state-error     .btn-pw-unlock:hover { background: #b91c1c; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(185,28,28,0.35); }
  /* verifying → disabled orange */
  .pw-modal.state-verifying .btn-pw-unlock { background: #fb923c; color: white; cursor: wait; pointer-events: none; }
  /* unlocked → green, close action */
  .pw-modal.state-unlocked  .btn-pw-unlock { background: #16a34a; color: white; }
  .pw-modal.state-unlocked  .btn-pw-unlock:hover { background: #15803d; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(21,128,61,0.35); }
  .btn-pw-unlock:disabled { opacity: 0.5; pointer-events: none; }

  .pw-verify-spinner {
    width: 14px; height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.65s linear infinite;
    flex-shrink: 0;
  }

  .btn-remove {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--ink-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .btn-remove:hover { background: var(--accent-soft); color: var(--accent); border-color: var(--accent); }

  .file-item-grid {
    display: grid;
    grid-template-columns: auto auto 1fr auto;
    gap: 0 12px;
    align-items: center;
  }

  /* ── Order number badge ── */
  .order-badge-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    flex-shrink: 0;
  }
  .order-num-input {
    width: 40px !important;
    height: 32px;
    border: 1.5px solid var(--border) !important;
    border-radius: 6px !important;
    background: var(--paper) !important;
    color: var(--ink) !important;
    font-size: 0.8rem !important;
    font-weight: 700 !important;
    font-family: 'Fraunces', serif !important;
    text-align: center;
    padding: 4px 4px !important;
    cursor: text;
    transition: all 0.15s;
    outline: none;
    appearance: none;
    -moz-appearance: textfield;
    display: block !important;
  }
  .order-num-input::-webkit-inner-spin-button,
  .order-num-input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  .order-num-input:focus {
    border-color: var(--accent) !important;
    background: var(--surface) !important;
    box-shadow: 0 0 0 3px rgba(200,75,49,0.12) !important;
    transform: scale(1.05);
  }
  .order-num-input.order-conflict {
    border-color: #f59e0b !important;
    background: #fffbeb !important;
  }
  .order-label {
    font-size: 0.58rem;
    color: var(--ink-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
  }

  /* ── File list toolbar ── */
  .file-list-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }
  .toolbar-search {
    flex: 1;
    min-width: 120px;
    position: relative;
  }
  .toolbar-search input {
    width: 100% !important;
    padding: 7px 10px 7px 30px !important;
    font-size: 0.78rem !important;
    height: 32px;
    border-radius: 6px !important;
    background: var(--paper) !important;
  }
  .toolbar-search-icon {
    position: absolute;
    left: 8px; top: 50%;
    transform: translateY(-50%);
    color: var(--ink-muted);
    pointer-events: none;
  }
  .toolbar-btn {
    height: 32px;
    padding: 0 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--surface);
    color: var(--ink-soft);
    font-size: 0.75rem;
    font-weight: 600;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    display: flex; align-items: center; gap: 5px;
    white-space: nowrap;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .toolbar-btn:hover { background: var(--paper); border-color: var(--ink-muted); color: var(--ink); }
  .toolbar-btn.active { background: var(--ink); color: white; border-color: var(--ink); }
  .toolbar-btn.danger:hover { background: var(--accent-soft); color: var(--accent); border-color: var(--accent); }

  /* ── Infinite scroll container ── */
  .file-list-scroll {
    max-height: 560px;
    overflow-y: auto;
    overflow-x: hidden;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
    border-radius: var(--radius-sm);
  }
  .file-list-scroll::-webkit-scrollbar { width: 5px; }
  .file-list-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .file-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 2px 0 4px;
  }

  /* ── Load more sentinel & loader ── */
  .load-more-sentinel {
    height: 1px;
    margin-top: 4px;
  }
  .load-more-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 0 4px;
    font-size: 0.75rem;
    color: var(--ink-muted);
    display: none;
  }
  .load-more-spinner.visible { display: flex; }
  .mini-spinner {
    width: 14px; height: 14px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    flex-shrink: 0;
  }

  /* ── Pagination summary bar ── */
  .list-pagination-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0 0;
    font-size: 0.74rem;
    color: var(--ink-muted);
    display: none;
  }
  .list-pagination-bar.visible { display: flex; }
  .pagination-info strong { color: var(--ink-soft); }
  .btn-load-more {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--accent);
    background: var(--accent-soft);
    border: 1px solid rgba(200,75,49,0.2);
    border-radius: 6px;
    padding: 4px 10px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.15s;
  }
  .btn-load-more:hover { background: var(--accent); color: white; }

  /* ── File item (updated) ── */
  .file-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--paper);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    cursor: grab;
    transition: all 0.18s;
    position: relative;
    animation: itemSlideIn 0.2s ease both;
  }
  @keyframes itemSlideIn {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .file-item:hover { border-color: var(--ink-muted); box-shadow: var(--shadow-sm); background: var(--surface); }
  .file-item.dragging { opacity: 0.35; transform: scale(0.98); }
  .file-item.drag-over-item { border-color: var(--accent); background: var(--accent-soft); box-shadow: 0 0 0 2px rgba(200,75,49,0.15); }
  .file-item.order-moving { animation: orderPulse 0.35s ease; }
  @keyframes orderPulse {
    0%  { background: var(--accent-soft); }
    100%{ background: var(--paper); }
  }

  /* ── Reorder modal ── */
  #reorder-modal {
    display: none;
    position: fixed; inset: 0; z-index: 900;
    background: rgba(10,10,20,0.6);
    backdrop-filter: blur(4px);
    align-items: center; justify-content: center;
    animation: fadeIn 0.2s ease;
  }
  #reorder-modal.open { display: flex; }
  .reorder-shell {
    background: var(--surface);
    border-radius: var(--radius);
    width: min(480px, 94vw);
    max-height: 90vh;
    overflow: hidden;
    display: flex; flex-direction: column;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border);
    animation: scaleIn 0.22s cubic-bezier(0.34,1.56,0.64,1);
  }
  .reorder-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
  }
  .reorder-title {
    font-family: 'Fraunces', serif;
    font-size: 1rem; font-weight: 700; color: var(--ink); flex: 1;
  }
  .reorder-body {
    padding: 16px 20px;
    flex: 1; overflow-y: auto;
    scrollbar-width: thin;
    display: flex; flex-direction: column; gap: 8px;
  }
  .reorder-body p {
    font-size: 0.78rem; color: var(--ink-muted); margin-bottom: 8px; line-height: 1.5;
  }
  .reorder-textarea {
    width: 100%;
    min-height: 220px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    font-size: 0.8rem;
    font-family: 'DM Sans', monospace;
    color: var(--ink);
    background: var(--paper);
    resize: vertical;
    outline: none;
    line-height: 1.8;
  }
  .reorder-textarea:focus { border-color: var(--ink); box-shadow: 0 0 0 2px rgba(26,26,46,0.08); }
  .reorder-footer {
    padding: 14px 20px;
    border-top: 1px solid var(--border);
    display: flex; gap: 10px; justify-content: flex-end;
  }
  .btn-reorder-apply {
    padding: 9px 20px;
    background: var(--ink); color: white;
    border: none; border-radius: 8px;
    font-size: 0.85rem; font-weight: 600;
    font-family: 'DM Sans', sans-serif; cursor: pointer;
    transition: all 0.15s;
  }
  .btn-reorder-apply:hover { background: var(--accent); }
  .btn-reorder-cancel {
    padding: 9px 16px;
    background: transparent; color: var(--ink-muted);
    border: 1px solid var(--border); border-radius: 8px;
    font-size: 0.85rem; font-family: 'DM Sans', sans-serif; cursor: pointer;
    transition: all 0.15s;
  }
  .btn-reorder-cancel:hover { border-color: var(--ink-muted); color: var(--ink); }
  .reorder-error {
    font-size: 0.74rem; color: var(--accent);
    background: var(--accent-soft); padding: 6px 10px;
    border-radius: 6px; display: none;
  }
  .reorder-error.visible { display: block; }

  /* Form controls */
  .form-group { margin-bottom: 16px; }
  .form-group:last-child { margin-bottom: 0; }
  label {
    display: block;
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--ink-soft);
    margin-bottom: 6px;
    letter-spacing: 0.02em;
    text-transform: uppercase;
  }

  select, input[type="text"], input[type="number"] {
    width: 100%;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 9px 12px;
    font-size: 0.85rem;
    background: var(--paper);
    color: var(--ink);
    font-family: 'DM Sans', sans-serif;
    outline: none;
    transition: border-color 0.15s;
    appearance: none;
    -webkit-appearance: none;
  }
  select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238888aa' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }
  select:focus, input:focus { border-color: var(--ink); box-shadow: 0 0 0 2px rgba(26,26,46,0.08); }

  .toggle-group {
    display: flex;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
    background: var(--paper);
  }
  .toggle-btn {
    flex: 1;
    padding: 8px 12px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 0.82rem;
    font-weight: 500;
    color: var(--ink-muted);
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-family: 'DM Sans', sans-serif;
  }
  .toggle-btn.active {
    background: var(--ink);
    color: white;
  }

  .inline-row { display: flex; gap: 10px; }
  .inline-row > * { flex: 1; }

  /* Slider */
  .slider-wrap { position: relative; }
  input[type="range"] {
    width: 100%;
    height: 5px;
    border-radius: 3px;
    appearance: none;
    background: linear-gradient(to right, var(--accent) 0%, var(--accent) var(--val, 65%), var(--border) var(--val, 65%), var(--border) 100%);
    border: none;
    padding: 0;
    cursor: pointer;
    outline: none;
  }
  input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent);
    border: 2px solid white;
    box-shadow: 0 1px 6px rgba(200,75,49,0.4);
    cursor: pointer;
  }
  .slider-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 6px;
  }
  .slider-label {
    font-size: 0.68rem;
    color: var(--ink-muted);
    font-weight: 500;
  }

  .helper-note {
    background: var(--paper);
    border-left: 3px solid var(--border);
    padding: 10px 12px;
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    font-size: 0.75rem;
    color: var(--ink-muted);
    line-height: 1.5;
    font-style: italic;
    margin-top: 14px;
  }

  .size-row { display: flex; gap: 8px; align-items: flex-start; }
  .size-row input { flex: 1; }
  .size-row select { width: 80px; flex-shrink: 0; }

  /* Merge button */
  .btn-merge {
    width: 100%;
    padding: 15px 24px;
    background: var(--ink);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 0.95rem;
    font-weight: 600;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    margin-top: 20px;
    letter-spacing: 0.01em;
  }
  .btn-merge::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(200,75,49,0.12) 0%, transparent 60%);
  }
  .btn-merge:hover:not(:disabled) {
    background: var(--accent);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(200,75,49,0.3);
  }
  .btn-merge:disabled {
    opacity: 0.45;
    cursor: not-allowed;
    transform: none;
  }
  .btn-merge.loading { pointer-events: none; }

  .spinner {
    width: 18px;
    height: 18px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Success panel */
  #success-panel {
    display: none;
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid #bbf7d0;
    box-shadow: var(--shadow-sm);
    padding: 28px;
    margin-top: 20px;
    text-align: center;
    animation: slideUp 0.35s ease;
  }
  #success-panel.visible { display: block; }
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .success-icon {
    width: 56px;
    height: 56px;
    background: #f0fdf4;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
    border: 2px solid #86efac;
  }

  .success-title {
    font-family: 'Fraunces', serif;
    font-size: 1.2rem;
    font-weight: 700;
    color: #166534;
    margin-bottom: 16px;
  }

  .stats-row {
    display: flex;
    justify-content: center;
    gap: 24px;
    margin-bottom: 20px;
  }

  .stat-item { text-align: center; }
  .stat-value {
    font-family: 'Fraunces', serif;
    font-size: 1.6rem;
    font-weight: 700;
    color: var(--ink);
    line-height: 1;
  }
  .stat-label {
    font-size: 0.72rem;
    color: var(--ink-muted);
    margin-top: 4px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
  }

  .btn-download {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #166534;
    color: white;
    padding: 11px 24px;
    border-radius: var(--radius-sm);
    border: none;
    font-size: 0.88rem;
    font-weight: 600;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.18s;
    text-decoration: none;
  }
  .btn-download:hover { background: #14532d; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(22,101,52,0.3); }

  /* Empty state */
  .empty-message {
    text-align: center;
    padding: 30px 0 10px;
    color: var(--ink-muted);
    font-size: 0.82rem;
    font-style: italic;
  }

  /* Divider */
  .divider {
    height: 1px;
    background: var(--border);
    margin: 18px 0;
  }

  /* Custom size */
  #custom-size { display: none; }
  #custom-size.visible { display: flex; gap: 10px; }

  .section-label {
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 700;
    color: var(--ink-muted);
    margin-bottom: 12px;
  }

  .files-count-badge {
    margin-left: auto;
    background: var(--ink);
    color: white;
    font-size: 0.7rem;
    font-weight: 700;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }


  .merge-disabled-note {
    text-align: center;
    font-size: 0.76rem;
    color: var(--accent);
    margin-top: 8px;
    display: none;
  }
  .merge-disabled-note.visible { display: block; }

  /* ── Progress ── */
  #progress-wrap {
    display: none;
    margin-top: 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px 18px;
    animation: slideUp 0.2s ease;
  }
  #progress-wrap.visible { display: block; }
  .progress-label {
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--ink-soft);
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
  }
  .progress-bar-track {
    height: 6px;
    background: var(--paper);
    border-radius: 3px;
    overflow: hidden;
  }
  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent-mid));
    border-radius: 3px;
    transition: width 0.25s ease;
    width: 0%;
  }
  .progress-step {
    font-size: 0.72rem;
    color: var(--ink-muted);
    margin-top: 6px;
    font-style: italic;
  }

  /* ── Compression Report ── */
  .compression-report {
    background: var(--paper);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    padding: 14px 16px;
    margin-top: 16px;
    display: none;
  }
  .compression-report.visible { display: block; }
  .report-title {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    font-weight: 700;
    color: var(--ink-muted);
    margin-bottom: 10px;
  }
  .report-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.8rem;
  }
  .report-row:last-child { border-bottom: none; }
  .report-key { color: var(--ink-soft); }
  .report-val { font-weight: 600; color: var(--ink); }
  .report-val.green { color: #16a34a; }
  .report-val.amber { color: #d97706; }
  .savings-bar {
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 10px;
  }
  .savings-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #16a34a, #22c55e);
    border-radius: 4px;
    transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    width: 0%;
  }
  .savings-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.68rem;
    color: var(--ink-muted);
    margin-top: 4px;
  }

  /* ── Camera Modal ── */
  #camera-modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1000;
    background: rgba(10, 10, 20, 0.88);
    backdrop-filter: blur(6px);
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease;
  }
  #camera-modal.open { display: flex; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .camera-shell {
    background: #0f0f1a;
    border-radius: 20px;
    width: min(680px, 96vw);
    overflow: hidden;
    box-shadow: 0 24px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.07);
    display: flex;
    flex-direction: column;
    animation: scaleIn 0.25s cubic-bezier(0.34,1.56,0.64,1);
  }
  @keyframes scaleIn { from { transform: scale(0.88); opacity: 0; } to { transform: scale(1); opacity: 1; } }

  .camera-topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-bottom: 1px solid rgba(255,255,255,0.07);
  }
  .camera-topbar-title {
    display: flex;
    align-items: center;
    gap: 9px;
    font-family: 'Fraunces', serif;
    font-size: 0.95rem;
    font-weight: 600;
    color: white;
  }
  .cam-live-dot {
    width: 8px; height: 8px;
    background: #ef4444;
    border-radius: 50%;
    animation: pulse-dot 1.4s ease-in-out infinite;
  }
  @keyframes pulse-dot {
    0%,100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.7); }
  }
  .btn-cam-close {
    width: 32px; height: 32px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
    color: rgba(255,255,255,0.7);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .btn-cam-close:hover { background: rgba(200,75,49,0.3); color: white; border-color: rgba(200,75,49,0.5); }

  /* Viewfinder */
  .viewfinder-wrap {
    position: relative;
    background: #000;
    overflow: hidden;
    aspect-ratio: 4/3;
  }
  #cam-video {
    width: 100%; height: 100%;
    object-fit: cover;
    display: block;
  }
  /* Document corner guides overlay */
  .cam-overlay {
    position: absolute; inset: 0;
    pointer-events: none;
  }
  .cam-corner {
    position: absolute;
    width: 28px; height: 28px;
    border-color: rgba(200,75,49,0.85);
    border-style: solid;
  }
  .cam-corner.tl { top: 16px; left: 16px; border-width: 3px 0 0 3px; border-radius: 3px 0 0 3px; }
  .cam-corner.tr { top: 16px; right: 16px; border-width: 3px 3px 0 0; border-radius: 0 3px 0 0; }
  .cam-corner.bl { bottom: 16px; left: 16px; border-width: 0 0 3px 3px; border-radius: 0 0 0 3px; }
  .cam-corner.br { bottom: 16px; right: 16px; border-width: 0 3px 3px 0; border-radius: 0 0 3px 0; }
  .cam-guide-line-h {
    position: absolute; left: 50%; top: 50%;
    transform: translate(-50%, -50%);
    width: 60%; height: 1px;
    background: rgba(255,255,255,0.1);
  }
  .cam-guide-line-v {
    position: absolute; left: 50%; top: 50%;
    transform: translate(-50%, -50%);
    width: 1px; height: 60%;
    background: rgba(255,255,255,0.1);
  }
  /* Flash effect */
  .cam-flash {
    position: absolute; inset: 0;
    background: white;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.05s;
  }
  .cam-flash.flash { opacity: 1; }
  /* Cam error */
  #cam-error {
    display: none;
    position: absolute; inset: 0;
    background: #0f0f1a;
    align-items: center; justify-content: center;
    flex-direction: column; gap: 10px;
    color: rgba(255,255,255,0.5);
    font-size: 0.85rem; text-align: center; padding: 24px;
  }
  #cam-error.visible { display: flex; }

  /* Controls */
  .camera-controls {
    padding: 16px 18px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-top: 1px solid rgba(255,255,255,0.07);
    background: #0f0f1a;
  }

  .btn-cam-flip {
    width: 42px; height: 42px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.06);
    color: rgba(255,255,255,0.7);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.18s;
    flex-shrink: 0;
  }
  .btn-cam-flip:hover { background: rgba(255,255,255,0.12); color: white; }

  .btn-cam-shoot {
    flex: 1;
    height: 52px;
    border-radius: 26px;
    background: var(--accent);
    border: none;
    color: white;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: all 0.18s;
    position: relative;
    overflow: hidden;
  }
  .btn-cam-shoot::before {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, transparent 60%);
  }
  .btn-cam-shoot:hover { background: #a83922; transform: scale(1.02); box-shadow: 0 4px 16px rgba(200,75,49,0.4); }
  .btn-cam-shoot:active { transform: scale(0.97); }

  .cam-shot-count {
    background: rgba(255,255,255,0.1);
    color: rgba(255,255,255,0.6);
    font-size: 0.72rem;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 12px;
    white-space: nowrap;
    flex-shrink: 0;
    letter-spacing: 0.03em;
    min-width: 64px;
    text-align: center;
  }
  .cam-shot-count.has-shots { background: rgba(200,75,49,0.2); color: var(--accent-mid); }

  /* Thumbnails strip */
  .cam-thumbs-wrap {
    padding: 0 18px 14px;
    background: #0f0f1a;
    display: none;
  }
  .cam-thumbs-wrap.visible { display: block; }
  .cam-thumbs-label {
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 700;
    color: rgba(255,255,255,0.3);
    margin-bottom: 8px;
  }
  .cam-thumbs-row {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 4px;
    scrollbar-width: thin;
    scrollbar-color: rgba(255,255,255,0.1) transparent;
  }
  .cam-thumb {
    position: relative;
    flex-shrink: 0;
    width: 68px; height: 68px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid rgba(255,255,255,0.12);
    cursor: pointer;
    transition: border-color 0.15s;
  }
  .cam-thumb:hover { border-color: var(--accent); }
  .cam-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .cam-thumb-del {
    position: absolute; top: 3px; right: 3px;
    width: 18px; height: 18px;
    background: rgba(0,0,0,0.7);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; color: white; cursor: pointer;
    opacity: 0; transition: opacity 0.15s;
    border: none;
  }
  .cam-thumb:hover .cam-thumb-del { opacity: 1; }
  .cam-thumb-num {
    position: absolute; bottom: 3px; left: 4px;
    font-size: 0.6rem; font-weight: 700;
    color: white;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
  }

  /* Enhancement toggle */
  .cam-enhance-row {
    padding: 0 18px 14px;
    background: #0f0f1a;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .cam-enhance-label {
    font-size: 0.75rem;
    color: rgba(255,255,255,0.45);
    flex: 1;
  }
  .cam-toggle {
    position: relative;
    width: 36px; height: 20px;
    background: rgba(255,255,255,0.12);
    border-radius: 10px;
    cursor: pointer;
    border: none;
    transition: background 0.2s;
    flex-shrink: 0;
  }
  .cam-toggle::after {
    content: '';
    position: absolute;
    top: 3px; left: 3px;
    width: 14px; height: 14px;
    background: white;
    border-radius: 50%;
    transition: transform 0.2s;
  }
  .cam-toggle.on { background: var(--accent); }
  .cam-toggle.on::after { transform: translateX(16px); }

  /* Add to queue button */
  .cam-footer {
    padding: 14px 18px;
    border-top: 1px solid rgba(255,255,255,0.07);
    background: #0d0d18;
    display: flex; gap: 10px;
  }
  .btn-cam-add {
    flex: 1;
    padding: 11px;
    background: linear-gradient(135deg, #2a7f7f, #1d6060);
    color: white;
    border: none;
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.88rem;
    font-weight: 600;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: all 0.18s;
  }
  .btn-cam-add:hover:not(:disabled) { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(42,127,127,0.4); }
  .btn-cam-add:disabled { opacity: 0.35; cursor: not-allowed; }
  .btn-cam-clear {
    padding: 11px 16px;
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.5);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.82rem;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn-cam-clear:hover { background: rgba(200,75,49,0.15); color: var(--accent-mid); border-color: rgba(200,75,49,0.3); }

  /* Camera button in upload area */
  .upload-actions {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .btn-camera {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    background: var(--teal-soft);
    color: var(--teal);
    padding: 9px 20px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    border: 1px solid rgba(42,127,127,0.25);
    cursor: pointer;
    transition: all 0.18s;
    font-family: 'DM Sans', sans-serif;
  }
  .btn-camera:hover { background: var(--teal); color: white; transform: translateY(-1px); box-shadow: var(--shadow-sm); }
  @keyframes shake-anim {
    0%,100% { transform: translateX(0); }
    20%     { transform: translateX(-6px); }
    40%     { transform: translateX(6px); }
    60%     { transform: translateX(-4px); }
    80%     { transform: translateX(4px); }
  }
  .shake-anim { animation: shake-anim 0.35s ease; }
</style>
</head>
<body>

<div class="app-wrap">
  <header>
    <div class="logo-mark">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
        <line x1="12" y1="18" x2="12" y2="12"/>
        <line x1="9" y1="15" x2="15" y2="15"/>
      </svg>
    </div>
    <div class="logo-text">
      <h1>DocMerge</h1>
      <p>Merge PDFs & images — entirely in your browser</p>
    </div>
    <span class="header-badge">No upload · Private</span>
  </header>

  <div class="main-grid">
    <!-- Left column -->
    <div style="display:flex;flex-direction:column;gap:20px;">

      <!-- Drop zone card -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon red">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
          </div>
          <span class="card-title">Add Files</span>
        </div>
        <div class="card-body">
          <div class="drop-zone" id="drop-zone">
            <div class="drop-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#c84b31" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
            </div>
            <h3>Drop files here</h3>
            <p>Drag & drop PDF or image files to merge them</p>
            <div class="upload-actions">
              <button class="btn-select" onclick="document.getElementById('file-input').click()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                Select Files
              </button>
              <button class="btn-camera" onclick="openCamera()">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                Use Camera
              </button>
            </div>
            <div class="format-tags">
              <span class="format-tag pdf">PDF</span>
              <span class="format-tag jpg">JPG</span>
              <span class="format-tag png">PNG</span>
            </div>
          </div>
          <input type="file" id="file-input" accept=".pdf,.jpg,.jpeg,.png" multiple style="display:none">
        </div>
      </div>

      <!-- File list card -->
      <div class="card" id="file-list-section">
        <div class="card-header">
          <div class="card-icon ink">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
          </div>
          <span class="card-title">File Queue</span>
          <div class="files-count-badge" id="files-count">0</div>
        </div>
        <div class="card-body">

          <!-- Toolbar -->
          <div class="file-list-toolbar">
            <div class="toolbar-search">
              <span class="toolbar-search-icon">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              </span>
              <input type="text" id="list-search" placeholder="Filter files…" oninput="onSearchChange()" autocomplete="off">
            </div>
            <button class="toolbar-btn" onclick="sortByName()" title="Sort A→Z">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="4" y1="6" x2="11" y2="6"/><line x1="4" y1="12" x2="11" y2="12"/><line x1="4" y1="18" x2="13" y2="18"/><polyline points="15 15 18 18 21 15"/><line x1="18" y1="6" x2="18" y2="18"/></svg>
              Sort A→Z
            </button>
            <button class="toolbar-btn" onclick="openReorderModal()" title="Bulk reorder by numbers">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
              Reorder
            </button>
            <button class="toolbar-btn danger" onclick="clearAllFiles()" title="Remove all files">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
              Clear
            </button>
          </div>

          <!-- Scrollable list with infinite loading -->
          <div class="file-list-scroll" id="file-list-scroll">
            <div class="file-list" id="file-list"></div>
            <div class="load-more-spinner" id="load-more-spinner">
              <div class="mini-spinner"></div>
              Loading more files…
            </div>
            <div class="load-more-sentinel" id="load-more-sentinel"></div>
          </div>

          <!-- Pagination info bar -->
          <div class="list-pagination-bar" id="pagination-bar">
            <span class="pagination-info" id="pagination-info">Showing <strong>0</strong> of <strong>0</strong> files</span>
            <button class="btn-load-more" id="btn-load-more" onclick="loadMoreItems()">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
              Load more
            </button>
          </div>

        </div>
      </div>

      <!-- Success panel -->
      <div id="success-panel">
        <div class="success-icon">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        <div class="success-title">Merged Successfully!</div>
        <div class="stats-row">
          <div class="stat-item">
            <div class="stat-value" id="stat-files">—</div>
            <div class="stat-label">Files</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="stat-pages">—</div>
            <div class="stat-label">Pages</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="stat-size">—</div>
            <div class="stat-label">Size</div>
          </div>
        </div>
        <a id="download-link" class="btn-download" href="#" download>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Download PDF
        </a>

        <div class="compression-report" id="compression-report">
          <div class="report-title">Compression Report</div>
          <div class="report-row">
            <span class="report-key">Original size</span>
            <span class="report-val" id="rep-original">—</span>
          </div>
          <div class="report-row">
            <span class="report-key">Final size</span>
            <span class="report-val" id="rep-final">—</span>
          </div>
          <div class="report-row">
            <span class="report-key">Space saved</span>
            <span class="report-val green" id="rep-saved">—</span>
          </div>
          <div class="report-row">
            <span class="report-key">Compression ratio</span>
            <span class="report-val green" id="rep-ratio">—</span>
          </div>
          <div class="report-row">
            <span class="report-key">Strategy applied</span>
            <span class="report-val" id="rep-strategy">—</span>
          </div>
          <div class="savings-bar"><div class="savings-bar-fill" id="savings-bar-fill"></div></div>
          <div class="savings-label"><span>0% savings</span><span id="savings-bar-label">—</span></div>
        </div>
      </div>

    </div>

    <!-- Right sidebar -->
    <div style="display:flex;flex-direction:column;gap:20px;">

      <!-- Output settings card -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon teal">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
          </div>
          <span class="card-title">Output Settings</span>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>Output File Name</label>
            <input type="text" id="output-name" value="merged-document.pdf" placeholder="merged-document.pdf">
          </div>
          <div class="form-group">
            <label>Page Size</label>
            <select id="page-size" onchange="handlePageSizeChange()">
              <option value="A4" selected>A4 (210 × 297 mm)</option>
              <option value="Letter">Letter (216 × 279 mm)</option>
              <option value="Legal">Legal (216 × 356 mm)</option>
              <option value="Custom">Custom…</option>
            </select>
          </div>
          <div id="custom-size" class="form-group">
            <div class="inline-row">
              <div>
                <label>Width (mm)</label>
                <input type="number" id="custom-w" placeholder="210" min="10" max="5000">
              </div>
              <div>
                <label>Height (mm)</label>
                <input type="number" id="custom-h" placeholder="297" min="10" max="5000">
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>Orientation</label>
            <div class="toggle-group">
              <button class="toggle-btn active" id="btn-portrait" onclick="setOrientation('portrait')">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="5" y="2" width="14" height="20" rx="2"/></svg>
                Portrait
              </button>
              <button class="toggle-btn" id="btn-landscape" onclick="setOrientation('landscape')">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="5" width="20" height="14" rx="2"/></svg>
                Landscape
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Compression card -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon gold">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/></svg>
          </div>
          <span class="card-title">Compression & Size</span>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>Target Output Size</label>
            <div class="size-row">
              <input type="number" id="target-size" placeholder="e.g. 5" min="1">
              <select id="size-unit">
                <option value="KB">KB</option>
                <option value="MB" selected>MB</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Compression Quality</label>
            <div class="slider-wrap">
              <input type="range" id="quality-slider" min="1" max="100" value="65" oninput="updateSlider(this)" style="--val:65%">
            </div>
            <div class="slider-labels">
              <span class="slider-label">Small Size</span>
              <span class="slider-label">Balanced</span>
              <span class="slider-label">High Quality</span>
            </div>
          </div>
          <div class="helper-note">
            Exact file size cannot be guaranteed. This is a best-effort optimization using pdf-lib's built-in compression.
          </div>
        </div>
      </div>

      <!-- Merge button -->
      <button class="btn-merge" id="merge-btn" disabled onclick="startMerge()">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-3"/><polyline points="8 6 12 2 16 6"/><line x1="12" y1="2" x2="12" y2="13"/></svg>
        Merge & Download PDF
      </button>
      <div class="merge-disabled-note" id="merge-disabled-note">
        ⚠ Enter passwords for all locked PDFs to continue
      </div>

      <!-- Progress -->
      <div id="progress-wrap">
        <div class="progress-label">
          <span id="progress-label-text">Processing…</span>
          <span id="progress-pct">0%</span>
        </div>
        <div class="progress-bar-track">
          <div class="progress-bar-fill" id="progress-bar"></div>
        </div>
        <div class="progress-step" id="progress-step">Initializing…</div>
      </div>

    </div>
  </div>
</div>

<script>
const { PDFDocument, PageSizes, degrees } = PDFLib;

let files = [];
let dragSrc = null;
let orientation = 'portrait';

// ─── File Input ──────────────────────────────────────────────────────────────

function initMainListeners() {
  const fileInput = document.getElementById('file-input');
  if (fileInput) {
    fileInput.addEventListener('change', e => {
      addFiles(Array.from(e.target.files));
      e.target.value = '';
    });
  }

  const dropZone = document.getElementById('drop-zone');
  if (dropZone) {
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      addFiles(Array.from(e.dataTransfer.files).filter(f => /\.(pdf|jpg|jpeg|png)$/i.test(f.name)));
    });
  }

  const reorderModal = document.getElementById('reorder-modal');
  if (reorderModal) {
    reorderModal.addEventListener('click', e => {
      if (e.target === reorderModal) closeReorderModal();
    });
  }
}

document.addEventListener('DOMContentLoaded', initMainListeners);

async function addFiles(newFiles) {
  for (const f of newFiles) {
    if (!files.find(x => x.name === f.name && x.size === f.size)) {
      const entry = { id: Date.now() + Math.random(), file: f, name: f.name, size: f.size, type: getType(f), pageCount: null, password: '', pwError: false, isEncrypted: false };
      if (entry.type === 'pdf') {
        await detectPdfInfo(entry);
      }
      files.push(entry);
    }
  }
  renderList();
}

function getType(f) {
  if (f.name.toLowerCase().endsWith('.pdf')) return 'pdf';
  return 'img';
}

async function detectPdfInfo(entry) {
  try {
    const buf = await entry.file.arrayBuffer();
    const pdf = await PDFDocument.load(buf, { ignoreEncryption: true });
    entry.pageCount = pdf.getPageCount();
    // Check if encrypted by trying with empty password
    try { await PDFDocument.load(buf); } catch(e) {
      if (e.message && e.message.includes('encrypt')) entry.isEncrypted = true;
    }
  } catch(e) {
    entry.pageCount = '?';
    if (e.message && (e.message.toLowerCase().includes('encrypt') || e.message.toLowerCase().includes('password'))) {
      entry.isEncrypted = true;
    }
  }
}

// ─── Render & Pagination ──────────────────────────────────────────────────────

const PAGE_SIZE = 10;           // items loaded per batch
let visibleCount = PAGE_SIZE;   // how many items currently rendered
let searchQuery = '';           // current search filter
let intersectionObs = null;     // IntersectionObserver for sentinel

// Returns the filtered+sorted view of files (does NOT mutate `files`)
function getFilteredFiles() {
  if (!searchQuery) return files;
  const q = searchQuery.toLowerCase();
  return files.filter(f => f.name.toLowerCase().includes(q));
}

function renderList() {
  const listEl   = document.getElementById('file-list');
  const section  = document.getElementById('file-list-section');
  const countEl  = document.getElementById('files-count');
  const pagBar   = document.getElementById('pagination-bar');
  const pagInfo  = document.getElementById('pagination-info');
  const loadMore = document.getElementById('btn-load-more');

  const filtered = getFilteredFiles();
  const total    = filtered.length;
  const showing  = Math.min(visibleCount, total);

  // Show/hide card
  section.classList.toggle('visible', files.length > 0);
  countEl.textContent = files.length;

  listEl.innerHTML = '';

  // Render only the visible slice
  const slice = filtered.slice(0, showing);
  slice.forEach((entry, sliceIdx) => {
    const globalIdx = files.indexOf(entry); // true position in files[]
    const isImg = entry.type === 'img';

    const el = document.createElement('div');
    el.className = 'file-item';
    el.dataset.id = entry.id;
    el.draggable = true;
    // Stagger entrance animation
    el.style.animationDelay = (sliceIdx * 18) + 'ms';

    el.innerHTML = `
      <div class="order-badge-wrap">
        <input
          type="number"
          class="order-num-input"
          value="${globalIdx + 1}"
          min="1"
          max="${files.length}"
          title="Enter a position number to move this file"
          data-id="${entry.id}"
          onchange="handleOrderChange(this)"
          onfocus="this.select()"
        >
        <span class="order-label">#pos</span>
      </div>

      <div class="drag-handle" title="Drag to reorder">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="9" cy="7" r="1" fill="currentColor"/><circle cx="9" cy="12" r="1" fill="currentColor"/><circle cx="9" cy="17" r="1" fill="currentColor"/><circle cx="15" cy="7" r="1" fill="currentColor"/><circle cx="15" cy="12" r="1" fill="currentColor"/><circle cx="15" cy="17" r="1" fill="currentColor"/></svg>
      </div>

      <div class="file-type-icon ${isImg ? 'img' : 'pdf'}">
        ${isImg
          ? `<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`
          : `<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>`
        }
      </div>

      <div class="file-info">
        <div class="file-name">${entry.name}</div>
        <div class="file-meta">
          <span>${formatSize(entry.size)}</span>
          ${entry.type === 'pdf' && entry.pageCount !== null ? `<span class="page-count">${entry.pageCount} pg</span>` : ''}
          ${entry.isCameraShot ? `<span style="background:var(--teal-soft);color:var(--teal);font-size:0.68rem;font-weight:600;padding:2px 7px;border-radius:3px;border:1px solid rgba(42,127,127,0.2);">📷</span>` : ''}
        </div>
        ${entry.isEncrypted ? `
          <div style="margin-top:6px;">
            <button
              id="btn-lock-${entry.id}"
              class="btn-lock ${entry.pwUnlocked ? 'lock-unlocked' : entry.pwError ? 'lock-error' : 'lock-locked'}"
              onclick="openPwModal('${entry.id}')"
              title="${entry.pwUnlocked ? 'PDF unlocked — click to change password' : 'Click to enter PDF password'}"
            >
              <svg class="btn-lock-svg" viewBox="0 0 24 24" fill="none">
                <path class="btn-lock-shackle" d="M8 11V7a4 4 0 0 1 8 0v4"
                  stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                <rect class="btn-lock-body" x="5" y="11" width="14" height="10" rx="2"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle class="btn-lock-keyhole" cx="12" cy="16" r="1.5"/>
              </svg>
              <span id="btn-lock-label-${entry.id}">
                ${entry.pwUnlocked ? 'Unlocked' : entry.pwError ? 'Wrong Password' : 'Enter Password'}
              </span>
            </button>
          </div>
        ` : ''}
      </div>

      <button class="btn-remove" onclick="removeFile('${entry.id}')" title="Remove">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    `;

    // ── Drag-to-reorder (works within the visible slice, updates real files[]) ──
    el.addEventListener('dragstart', e => {
      dragSrc = entry.id;
      el.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    el.addEventListener('dragend', () => el.classList.remove('dragging'));
    el.addEventListener('dragover', e => { e.preventDefault(); el.classList.add('drag-over-item'); });
    el.addEventListener('dragleave', () => el.classList.remove('drag-over-item'));
    el.addEventListener('drop', e => {
      e.preventDefault();
      el.classList.remove('drag-over-item');
      if (dragSrc && dragSrc !== entry.id) {
        const fromIdx = files.findIndex(x => String(x.id) === String(dragSrc));
        const toIdx   = files.findIndex(x => String(x.id) === String(entry.id));
        const [moved] = files.splice(fromIdx, 1);
        files.splice(toIdx, 0, moved);
        renderList();
      }
    });

    listEl.appendChild(el);
  });

  // Pagination bar
  const hasMore = showing < total;
  pagBar.classList.toggle('visible', total > PAGE_SIZE);
  pagInfo.innerHTML = `Showing <strong>${showing}</strong> of <strong>${total}${searchQuery ? ' matching' : ''}</strong> files`;
  loadMore.style.display = hasMore ? 'inline-flex' : 'none';

  // Re-observe sentinel for infinite scroll
  setupIntersectionObserver();
  updateMergeBtn();
}

// ── Infinite scroll via IntersectionObserver ──────────────────────────────────

function setupIntersectionObserver() {
  if (intersectionObs) intersectionObs.disconnect();

  const sentinel = document.getElementById('load-more-sentinel');
  const spinner  = document.getElementById('load-more-spinner');

  intersectionObs = new IntersectionObserver(entries => {
    if (entries[0].isIntersecting) {
      const filtered = getFilteredFiles();
      if (visibleCount < filtered.length) {
        spinner.classList.add('visible');
        setTimeout(() => {
          spinner.classList.remove('visible');
          visibleCount += PAGE_SIZE;
          renderList();
        }, 300); // slight delay so spinner shows
      }
    }
  }, { root: document.getElementById('file-list-scroll'), threshold: 0.1 });

  intersectionObs.observe(sentinel);
}

function loadMoreItems() {
  visibleCount += PAGE_SIZE;
  renderList();
  // Scroll to newly loaded items
  const scroll = document.getElementById('file-list-scroll');
  setTimeout(() => { scroll.scrollTop = scroll.scrollHeight; }, 50);
}

// ── Search/filter ─────────────────────────────────────────────────────────────

function onSearchChange() {
  searchQuery = document.getElementById('list-search').value.trim();
  visibleCount = PAGE_SIZE; // reset to first page on new search
  renderList();
}

// ── Sort ─────────────────────────────────────────────────────────────────────

function sortByName() {
  files.sort((a, b) => a.name.localeCompare(b.name));
  visibleCount = PAGE_SIZE;
  renderList();
  // Briefly highlight the sort button
  const btn = event.currentTarget;
  btn.classList.add('active');
  setTimeout(() => btn.classList.remove('active'), 800);
}

// ── Clear all ────────────────────────────────────────────────────────────────

function clearAllFiles() {
  if (files.length === 0) return;
  if (files.length > 3 && !confirm(`Remove all ${files.length} files from the queue?`)) return;
  files = [];
  visibleCount = PAGE_SIZE;
  searchQuery = '';
  document.getElementById('list-search').value = '';
  renderList();
}

// ── Order number field handler ────────────────────────────────────────────────
// When user types a new number into the order input, move that file to the
// desired position. Clamps to valid range; shows brief pulse animation.

function handleOrderChange(input) {
  const id      = input.dataset.id;
  const newPos  = parseInt(input.value, 10);
  const clipped = Math.max(1, Math.min(files.length, isNaN(newPos) ? 1 : newPos));

  const fromIdx = files.findIndex(x => String(x.id) === String(id));
  if (fromIdx === -1) return;

  const toIdx = clipped - 1;
  if (fromIdx === toIdx) { input.value = clipped; return; }

  // Move in the real files array
  const [moved] = files.splice(fromIdx, 1);
  files.splice(toIdx, 0, moved);

  // Ensure the moved item stays visible
  const targetPage = Math.ceil((toIdx + 1) / PAGE_SIZE);
  visibleCount = Math.max(visibleCount, targetPage * PAGE_SIZE);

  renderList();

  // After re-render, scroll to & flash the moved item
  requestAnimationFrame(() => {
    const movedEl = document.querySelector(`.file-item[data-id="${id}"]`);
    if (movedEl) {
      movedEl.classList.add('order-moving');
      movedEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      setTimeout(() => movedEl.classList.remove('order-moving'), 400);
    }
  });
}

// ── Reorder modal ─────────────────────────────────────────────────────────────
// Shows all file names as a numbered list the user can freely edit/rearrange

function openReorderModal() {
  const ta = document.getElementById('reorder-textarea');
  ta.value = files.map((f, i) => `${i + 1}. ${f.name}`).join('\n');
  document.getElementById('reorder-error').classList.remove('visible');
  document.getElementById('reorder-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  setTimeout(() => ta.focus(), 100);
}

function closeReorderModal() {
  document.getElementById('reorder-modal').classList.remove('open');
  document.body.style.overflow = '';
}

function applyReorderModal() {
  const errEl = document.getElementById('reorder-error');
  const lines = document.getElementById('reorder-textarea').value
    .split('\n')
    .map(l => l.trim())
    .filter(Boolean);

  // Extract file names by stripping leading "N. " prefix if present
  const names = lines.map(l => l.replace(/^\d+\.\s*/, '').trim());

  if (names.length !== files.length) {
    errEl.textContent = `Expected ${files.length} lines (one per file), got ${names.length}.`;
    errEl.classList.add('visible');
    return;
  }

  // Build new order by matching names back to file entries
  const newOrder = [];
  const usedIds = new Set();

  for (const name of names) {
    const match = files.find(f => f.name === name && !usedIds.has(f.id));
    if (!match) {
      errEl.textContent = `File not found: "${name}". Make sure every file name is kept exactly as shown.`;
      errEl.classList.add('visible');
      return;
    }
    newOrder.push(match);
    usedIds.add(match.id);
  }

  files = newOrder;
  visibleCount = PAGE_SIZE;
  closeReorderModal();
  renderList();
}

function removeFile(id) {
  // Cancel any pending password verification for this file
  clearTimeout(pwVerifyTimers[id]);
  delete pwVerifyTimers[id];
  delete pwBufCache[id];

  files = files.filter(f => String(f.id) !== String(id));
  visibleCount = Math.min(visibleCount, Math.max(PAGE_SIZE, files.length));
  renderList();
}

// ─── Password Modal System ───────────────────────────────────────────────────
// Architecture:
//   - Each encrypted PDF gets a compact lock button in the file row.
//   - Clicking it opens a single shared modal (<div id="pw-modal-root">).
//   - User types password, clicks "Unlock" → pdf-lib verifies immediately.
//   - On success: modal closes, button turns green + unlocked icon.
//   - On failure: lock shakes, error shown, user can retry.

const pwBufCache = {};     // ArrayBuffer cache keyed by entry id
let   pwModalActiveId = null; // which file is the modal currently for

// ── Open modal ────────────────────────────────────────────────────────────────
function openPwModal(id) {
  const entry = files.find(x => String(x.id) === String(id));
  if (!entry) return;

  pwModalActiveId = id;
  document.body.style.overflow = 'hidden';

  const modal  = document.getElementById('pw-modal-root');
  const inner  = document.getElementById('pw-modal-inner');
  const fname  = document.getElementById('pw-modal-fname');
  const input  = document.getElementById('pw-modal-input');
  const dots   = document.getElementById('pw-modal-dots');
  const status = document.getElementById('pw-modal-status');
  const unlockBtn = document.getElementById('btn-pw-unlock');
  const eyeBtn    = document.getElementById('pw-modal-eye-btn');

  // Reset eye toggle
  input.type = 'password';
  eyeBtn.classList.remove('showing');

  // Populate file name
  fname.textContent = entry.name;

  // Pre-fill if they had entered a password before
  input.value = entry.password || '';

  // Reset dot bars & status
  dots.innerHTML = Array(4).fill('<div class="pw-modal-dot"></div>').join('');
  status.textContent = '';

  // Set initial modal state
  const initState = entry.pwUnlocked ? 'state-unlocked'
                  : entry.pwError    ? 'state-error'
                  :                    'state-locked';
  setModalState(initState);

  if (entry.pwUnlocked) {
    document.getElementById('pw-modal-title').textContent = 'PDF Unlocked';
    document.getElementById('pw-modal-sub').textContent   = 'Password is set. You can change it below.';
    status.textContent = '✓ Password verified — PDF will be merged.';
    unlockBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg> Done — Close`;
    updateModalDots(entry.password || '');
  } else if (entry.pwError) {
    document.getElementById('pw-modal-title').textContent = 'Wrong Password';
    document.getElementById('pw-modal-sub').textContent   = 'The previous password was incorrect. Try again.';
    status.textContent = '⚠ Incorrect password — please try again.';
    unlockBtn.innerHTML = \`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M8 11V7a4 4 0 0 1 8 0v4"/><rect x="5" y="11" width="14" height="10" rx="2"/></svg> Try Again\`;
  } else {
    document.getElementById('pw-modal-title').textContent = 'PDF is Locked';
    document.getElementById('pw-modal-sub').textContent   = 'Enter the password to include this file in the merge.';
    unlockBtn.innerHTML = \`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M8 11V7a4 4 0 0 1 8 0v4"/><rect x="5" y="11" width="14" height="10" rx="2"/></svg> Unlock PDF\`;
  }

  modal.classList.add('open');

  // Focus input (unless already unlocked)
  setTimeout(() => {
    if (!entry.pwUnlocked) input.focus();
  }, 120);
}

function closePwModal() {
  document.getElementById('pw-modal-root').classList.remove('open');
  document.body.style.overflow = '';
  pwModalActiveId = null;
}

// ── Modal state helper ────────────────────────────────────────────────────────
function setModalState(state) {
  const modal = document.getElementById('pw-modal-inner');
  modal.className = 'pw-modal ' + state;
}

// ── Typing handler (live dots only, no verification) ─────────────────────────
function onPwModalInput(val) {
  if (!pwModalActiveId) return;
  const entry = files.find(x => String(x.id) === String(pwModalActiveId));
  if (!entry) return;

  // Update stored password value
  entry.password    = val;
  entry.pwError     = false;
  entry.pwUnlocked  = false;

  const status    = document.getElementById('pw-modal-status');
  const unlockBtn = document.getElementById('btn-pw-unlock');

  status.textContent = '';

  if (!val) {
    setModalState('state-locked');
    document.getElementById('pw-modal-title').textContent = 'PDF is Locked';
    document.getElementById('pw-modal-sub').textContent   = 'Enter the password to include this file in the merge.';
    unlockBtn.innerHTML = \`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M8 11V7a4 4 0 0 1 8 0v4"/><rect x="5" y="11" width="14" height="10" rx="2"/></svg> Unlock PDF\`;
  } else {
    setModalState('state-typing');
    document.getElementById('pw-modal-title').textContent = 'Enter Password';
    document.getElementById('pw-modal-sub').textContent   = 'Click "Unlock PDF" when done to verify.';
    unlockBtn.innerHTML = \`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M8 11V7a4 4 0 0 1 8 0v4"/><rect x="5" y="11" width="14" height="10" rx="2"/></svg> Unlock PDF\`;
  }

  updateModalDots(val);
  updateMergeBtn();
}

// ── Strength dots ─────────────────────────────────────────────────────────────
function updateModalDots(val) {
  const dotEls = document.querySelectorAll('#pw-modal-dots .pw-modal-dot');
  const thresholds = [1, 4, 7, 10];
  dotEls.forEach((dot, i) => {
    dot.className = 'pw-modal-dot';
    if (!val || val.length < thresholds[i]) return;
    dot.classList.add(val.length < 4 ? 'weak' : val.length < 10 ? 'medium' : 'strong');
  });
}

// ── Eye toggle ────────────────────────────────────────────────────────────────
function toggleModalEye() {
  const input  = document.getElementById('pw-modal-input');
  const eyeBtn = document.getElementById('pw-modal-eye-btn');
  const showing = eyeBtn.classList.contains('showing');
  input.type = showing ? 'password' : 'text';
  eyeBtn.classList.toggle('showing', !showing);
}

// ── Verify on Unlock button click ─────────────────────────────────────────────
async function verifyPwAndUnlock() {
  const id = pwModalActiveId;
  if (!id) return;

  const entry = files.find(x => String(x.id) === String(id));
  if (!entry) return;

  // If already unlocked, just close
  if (entry.pwUnlocked) { closePwModal(); return; }

  const val = document.getElementById('pw-modal-input').value;
  const status    = document.getElementById('pw-modal-status');
  const unlockBtn = document.getElementById('btn-pw-unlock');

  if (!val) {
    // No password — shake & warn
    setModalState('state-error');
    status.textContent = '⚠ Please enter a password first.';
    document.getElementById('pw-modal-input').classList.add('shake-anim');
    setTimeout(() => document.getElementById('pw-modal-input').classList.remove('shake-anim'), 400);
    return;
  }

  // Show verifying state
  setModalState('state-verifying');
  document.getElementById('pw-modal-title').textContent = 'Verifying…';
  document.getElementById('pw-modal-sub').textContent   = 'Checking your password against the PDF…';
  unlockBtn.innerHTML = \`<div class="pw-verify-spinner"></div> Checking…\`;
  status.textContent  = '';

  try {
    // Cache ArrayBuffer
    if (!pwBufCache[id]) {
      pwBufCache[id] = await entry.file.arrayBuffer();
    }
    const buf = pwBufCache[id];

    // Verify — throws if wrong
    await PDFDocument.load(buf, { password: val, ignoreEncryption: false });

    // Also grab page count now that we can read the PDF
    try {
      const verifiedPdf = await PDFDocument.load(buf, { password: val });
      entry.pageCount = verifiedPdf.getPageCount();
    } catch(_) {}

    entry.password   = val;
    entry.pwUnlocked = true;
    entry.pwError    = false;

    // ── Success ──────────────────────────────────────────────────────────────
    setModalState('state-unlocked');
    document.getElementById('pw-modal-title').textContent = 'PDF Unlocked!';
    document.getElementById('pw-modal-sub').textContent   = 'This file will be included in the merge.';
    status.textContent = '✓ Password verified — ready to merge.';
    unlockBtn.innerHTML = \`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg> Done\`;

    // Update the lock button in the file list
    updateLockBtn(id);
    updateMergeBtn();

    // Auto-close after 1.2s so user sees the success state
    setTimeout(() => { if (pwModalActiveId === id) closePwModal(); }, 1200);

  } catch(e) {
    const msg = (e.message || '').toLowerCase();
    const isWrongPw = msg.includes('password') || msg.includes('encrypt') ||
                      msg.includes('incorrect') || msg.includes('invalid') ||
                      msg.includes('wrong') || msg.includes('decrypt');

    entry.password   = val;
    entry.pwError    = isWrongPw;
    entry.pwUnlocked = false;

    setModalState('state-error');
    document.getElementById('pw-modal-title').textContent = 'Wrong Password';
    document.getElementById('pw-modal-sub').textContent   = isWrongPw
      ? 'That password is incorrect. Please try again.'
      : 'Could not read this PDF. It may be corrupted.';
    status.textContent = isWrongPw
      ? '❌ Incorrect password — please try again.'
      : '⚠ Could not verify. Try merging anyway.';
    unlockBtn.innerHTML = \`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M8 11V7a4 4 0 0 1 8 0v4"/><rect x="5" y="11" width="14" height="10" rx="2"/></svg> Try Again\`;

    // Shake input
    const input = document.getElementById('pw-modal-input');
    input.classList.add('shake-anim');
    setTimeout(() => input.classList.remove('shake-anim'), 400);
    input.focus(); input.select();

    updateLockBtn(id);
    updateMergeBtn();
  }
}

// ── Update lock button appearance in file list ────────────────────────────────
function updateLockBtn(id) {
  const entry   = files.find(x => String(x.id) === String(id));
  if (!entry) return;
  const btn     = document.getElementById(\`btn-lock-\${id}\`);
  const label   = document.getElementById(\`btn-lock-label-\${id}\`);
  const pgCount = btn?.closest('.file-item')?.querySelector('.page-count');

  if (!btn) return;

  btn.className = 'btn-lock ' + (entry.pwUnlocked ? 'lock-unlocked' : entry.pwError ? 'lock-error' : 'lock-locked');
  btn.title     = entry.pwUnlocked ? 'PDF unlocked — click to change password' : 'Click to enter PDF password';
  if (label) label.textContent = entry.pwUnlocked ? 'Unlocked' : entry.pwError ? 'Wrong Password' : 'Enter Password';

  // Update page count badge if we obtained it
  if (pgCount && entry.pageCount && entry.pageCount !== '?') {
    pgCount.textContent = \`\${entry.pageCount} pg\`;
  }
}

// Allow Enter key to trigger unlock
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && pwModalActiveId) {
    const modal = document.getElementById('pw-modal-root');
    if (modal && modal.classList.contains('open')) {
      e.preventDefault();
      verifyPwAndUnlock();
    }
  }
});

function updateMergeBtn() {
  const btn  = document.getElementById('merge-btn');
  const note = document.getElementById('merge-disabled-note');
  const hasFiles = files.length > 0;

  // Block merge only if:
  //   (a) encrypted PDF has no password entered AND not yet unlocked
  //   (b) last verification attempt returned wrong password (pwError)
  const missingPw = files.some(f => f.isEncrypted && !f.pwUnlocked && !f.password);
  const hasError  = files.some(f => f.isEncrypted && f.pwError);

  btn.disabled = !hasFiles || missingPw || hasError;
  note.classList.toggle('visible', hasFiles && (missingPw || hasError));
  note.textContent = hasError
    ? '⚠ Fix incorrect PDF password to continue'
    : '⚠ Unlock all password-protected PDFs to continue';
}

// ─── UI helpers ──────────────────────────────────────────────────────────────

function handlePageSizeChange() {
  const v = document.getElementById('page-size').value;
  document.getElementById('custom-size').classList.toggle('visible', v === 'Custom');
}

function setOrientation(o) {
  orientation = o;
  document.getElementById('btn-portrait').classList.toggle('active', o === 'portrait');
  document.getElementById('btn-landscape').classList.toggle('active', o === 'landscape');
}

function updateSlider(el) {
  el.style.setProperty('--val', el.value + '%');
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / 1048576).toFixed(2) + ' MB';
}

// ─── Merge & Compression Engine ──────────────────────────────────────────────
//
// PROBLEM (original implementation):
//   • mergedPdf.save() called with no options → no object stream compression
//   • PNG images embedded raw via embedPng() → lossless, often 3–10× larger than JPEG
//   • PDF pages copied wholesale via copyPages() → carries all source streams,
//     embedded fonts, duplicate resources, and uncompressed data as-is
//   • No image resolution capping → a 6000×4000 photo remains 6000×4000 in output
//   • Result: output ≈ sum of all inputs (zero net compression)
//
// SOLUTION — three-tier compression strategy driven by quality slider:
//
//   HIGH QUALITY  (slider 70–100):
//     · Images re-encoded to JPEG at 0.88 quality, max 2400px on long edge
//     · PDF pages preserved structurally (copyPages) — fonts/vectors intact
//     · pdf-lib object streams enabled (useObjectStreams: true)
//     · Estimated savings: 20–50% vs original for image-heavy docs
//
//   BALANCED      (slider 35–69):
//     · Images re-encoded to JPEG at 0.72 quality, max 1800px on long edge
//     · PDF pages rasterized via pdf.js at 150 DPI then JPEG re-embedded
//       → eliminates duplicate fonts, embedded subsets, unused resources
//     · Object streams enabled
//     · Estimated savings: 50–80%
//
//   SMALL SIZE    (slider 1–34):
//     · Images re-encoded to JPEG at 0.50 quality, max 1200px on long edge
//     · PDF pages rasterized at 96 DPI then JPEG re-embedded
//     · Object streams enabled
//     · Estimated savings: 70–90% (visible quality loss possible)
//
// TECHNIQUES APPLIED:
//   1. Image compression   — Canvas API re-encodes to JPEG with tunable quality
//   2. Resolution capping  — Canvas downsamples oversized images before embedding
//   3. PNG→JPEG            — Eliminates lossless overhead for photographic content
//   4. PDF page rasterization — Collapses complex page graphs into single JPEG XObjects
//   5. Stream compression  — useObjectStreams packs PDF object streams with Flate/zlib
//   6. Duplicate resource removal — rasterization naturally deduplicates fonts/images
//   7. Metadata stripping  — Creator/Producer set to minimal strings

// ─── Compression config derived from quality slider ───────────────────────────

function getCompressionConfig() {
  const q = parseInt(document.getElementById('quality-slider').value); // 1–100
  if (q >= 70) return {
    tier: 'High Quality',
    jpegQuality: 0.88,
    maxPx: 2400,
    rasterizePdfs: false,
    pdfDpi: 150,
    label: 'Image resampling + stream compression'
  };
  if (q >= 35) return {
    tier: 'Balanced',
    jpegQuality: 0.72,
    maxPx: 1800,
    rasterizePdfs: true,
    pdfDpi: 150,
    label: 'Rasterize PDFs + image resampling + stream compression'
  };
  return {
    tier: 'Small Size',
    jpegQuality: 0.50,
    maxPx: 1200,
    rasterizePdfs: true,
    pdfDpi: 96,
    label: 'Aggressive rasterize + heavy compression'
  };
}

// ─── Progress helpers ─────────────────────────────────────────────────────────

function showProgress() {
  document.getElementById('progress-wrap').classList.add('visible');
  setProgress(0, 'Starting…');
}

function hideProgress() {
  document.getElementById('progress-wrap').classList.remove('visible');
}

function setProgress(pct, step) {
  pct = Math.min(100, Math.round(pct));
  document.getElementById('progress-bar').style.width = pct + '%';
  document.getElementById('progress-pct').textContent = pct + '%';
  document.getElementById('progress-step').textContent = step;
}

// ─── Core image compression via Canvas ───────────────────────────────────────
//
// Strategy: load image into an offscreen canvas, downscale if needed,
// export as JPEG blob, return as ArrayBuffer ready for pdf-lib embedJpg().
//
// Why canvas? The Web Canvas API provides hardware-accelerated image decoding
// and bicubic-quality downsampling, producing far smaller JPEG output than
// embedding the raw file. A 4MB PNG photo typically becomes a 200–600KB JPEG.

async function compressImageToJpeg(arrayBuffer, fileName, config) {
  return new Promise((resolve, reject) => {
    const blob = new Blob([arrayBuffer]);
    const url = URL.createObjectURL(blob);
    const img = new Image();

    img.onload = () => {
      URL.revokeObjectURL(url);
      let { width, height } = img;
      const maxPx = config.maxPx;

      // Downsample: preserve aspect ratio, cap longest edge
      if (width > maxPx || height > maxPx) {
        const scale = maxPx / Math.max(width, height);
        width = Math.round(width * scale);
        height = Math.round(height * scale);
      }

      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');

      // White background (important for PNG transparency → JPEG)
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, width, height);
      ctx.drawImage(img, 0, 0, width, height);

      canvas.toBlob(blob => {
        if (!blob) return reject(new Error('Canvas toBlob failed'));
        blob.arrayBuffer().then(resolve).catch(reject);
      }, 'image/jpeg', config.jpegQuality);
    };

    img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('Image load failed: ' + fileName)); };
    img.src = url;
  });
}

// ─── PDF page rasterization via pdf.js ───────────────────────────────────────
//
// Why rasterize? When copying PDF pages with pdf-lib's copyPages(), all embedded
// resources (fonts, images, ICC profiles, Type3 glyphs, Form XObjects, etc.) are
// carried verbatim into the output, often representing 60–95% of PDF file size.
// By rendering each page to a canvas at the target DPI and re-embedding as JPEG,
// we collapse the entire page graph into a single compressed XObject — stripping
// all fonts, duplicate resources, and unused streams at the cost of text
// selectability. This is the same approach Ghostscript uses for "screen" output.

async function rasterizePdfPages(pdfArrayBuffer, password, config, onPageProgress) {
  // Configure pdf.js worker
  if (!pdfjsLib.GlobalWorkerOptions.workerSrc) {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }

  const loadOpts = { data: pdfArrayBuffer };
  if (password) loadOpts.password = password;

  const pdfDoc = await pdfjsLib.getDocument(loadOpts).promise;
  const pageCount = pdfDoc.numPages;
  const jpegBuffers = [];
  const pageDims = [];   // [width, height] in PDF points at 72 DPI

  const scale = config.pdfDpi / 72; // pdf.js renders at 72 DPI baseline

  for (let i = 1; i <= pageCount; i++) {
    const page = await pdfDoc.getPage(i);
    const viewport = page.getViewport({ scale });

    const canvas = document.createElement('canvas');
    canvas.width = Math.round(viewport.width);
    canvas.height = Math.round(viewport.height);
    const ctx = canvas.getContext('2d');

    // White background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    await page.render({ canvasContext: ctx, viewport }).promise;

    // Re-compress the rendered canvas to JPEG
    const jpegBuf = await new Promise((resolve, reject) => {
      canvas.toBlob(b => {
        if (!b) return reject(new Error('Canvas toBlob failed on page ' + i));
        b.arrayBuffer().then(resolve).catch(reject);
      }, 'image/jpeg', config.jpegQuality);
    });

    jpegBuffers.push(jpegBuf);

    // Store original page dims in points (for layout in output PDF)
    const origViewport = page.getViewport({ scale: 1 });
    pageDims.push([origViewport.width, origViewport.height]);

    if (onPageProgress) onPageProgress(i, pageCount);
  }

  return { jpegBuffers, pageDims };
}

// ─── Main merge + optimize pipeline ──────────────────────────────────────────

async function startMerge() {
  const btn = document.getElementById('merge-btn');
  btn.classList.add('loading');
  btn.innerHTML = `<div class="spinner"></div> Merging…`;
  showProgress();

  // Capture total input size before processing
  const totalInputBytes = files.reduce((s, f) => s + f.size, 0);

  await new Promise(r => setTimeout(r, 60)); // allow repaint

  try {
    const cfg = getCompressionConfig();
    const mergedPdf = await PDFDocument.create();

    // Strip metadata to minimal strings (saves ~200–500 bytes, signals optimization)
    mergedPdf.setCreator('DocMerge');
    mergedPdf.setProducer('DocMerge / pdf-lib');

    let totalPages = 0;
    const pageSize = getPageSize();
    const fileCount = files.length;

    for (let fi = 0; fi < fileCount; fi++) {
      const entry = files[fi];
      const baseProgress = (fi / fileCount) * 90;
      const sliceSize = 90 / fileCount;

      setProgress(baseProgress, `Processing "${entry.name}" (${fi + 1}/${fileCount})…`);
      await tick();

      if (entry.type === 'pdf') {
        const pdfBuf = await entry.file.arrayBuffer();

        if (cfg.rasterizePdfs) {
          // ── BALANCED / SMALL SIZE: rasterize PDF pages via pdf.js ──────────
          // This is the key compression step for PDFs. Each page becomes one
          // JPEG XObject, stripping all fonts, embedded resources, unused streams.
          try {
            const { jpegBuffers, pageDims } = await rasterizePdfPages(
              pdfBuf,
              entry.isEncrypted ? entry.password : '',
              cfg,
              (pageIdx, pageTotal) => {
                const sub = baseProgress + (pageIdx / pageTotal) * sliceSize;
                setProgress(sub, `Rasterizing page ${pageIdx}/${pageTotal} of "${entry.name}"…`);
              }
            );

            for (let pi = 0; pi < jpegBuffers.length; pi++) {
              const [pgW, pgH] = pageDims[pi];
              const page = mergedPdf.addPage([pgW, pgH]);

              // Embed the JPEG-compressed rasterized page
              const embeddedImg = await mergedPdf.embedJpg(jpegBuffers[pi]);
              page.drawImage(embeddedImg, { x: 0, y: 0, width: pgW, height: pgH });
              totalPages++;
            }

            // ✓ If encrypted, mark as unlocked now that pages loaded successfully
            if (entry.isEncrypted && entry.password) markPwUnlocked(entry.id);
          } catch(e) {
            if (e.message && e.message.toLowerCase().includes('password')) {
              entry.pwError = true;
              markPwError(entry.id);
              throw new Error(`Wrong password for "${entry.name}".`);
            }
            throw e;
          }

        } else {
          // ── HIGH QUALITY: structural copy (preserves vectors & text) ────────
          // pdf-lib copyPages preserves all content streams. We still benefit from
          // useObjectStreams compression applied at save() time.
          const opts = { ignoreEncryption: false };
          if (entry.isEncrypted && entry.password) opts.password = entry.password;

          let srcPdf;
          try {
            srcPdf = await PDFDocument.load(pdfBuf, opts);
          } catch(e) {
            if (e.message && (e.message.includes('encrypt') || e.message.includes('password'))) {
              entry.pwError = true;
              markPwError(entry.id);
              throw new Error(`Wrong password for "${entry.name}".`);
            }
            // Fallback: try ignoring encryption (read-only path)
            srcPdf = await PDFDocument.load(pdfBuf, { ignoreEncryption: true });
          }

          const pageIdxs = srcPdf.getPageIndices();
          const copiedPages = await mergedPdf.copyPages(srcPdf, pageIdxs);
          copiedPages.forEach(p => { mergedPdf.addPage(p); totalPages++; });
          // ✓ If encrypted, mark as unlocked
          if (entry.isEncrypted && entry.password) markPwUnlocked(entry.id);
          setProgress(baseProgress + sliceSize, `Copied ${pageIdxs.length} pages from "${entry.name}"`);
        }

      } else {
        // ── IMAGE FILES (JPG / PNG) ───────────────────────────────────────────
        // Step 1: Read raw bytes
        const rawBuf = await entry.file.arrayBuffer();
        setProgress(baseProgress + sliceSize * 0.3, `Compressing image "${entry.name}"…`);
        await tick();

        // Step 2: Re-encode via canvas (downsample + JPEG compression)
        // Even existing JPEGs benefit: oversized ones get downsampled,
        // and all go through our quality budget.
        const compressedBuf = await compressImageToJpeg(rawBuf, entry.name, cfg);

        // Step 3: Embed the optimized JPEG into the PDF
        const embeddedImg = await mergedPdf.embedJpg(compressedBuf);
        const { width: imgW, height: imgH } = embeddedImg.scale(1);

        let pgW = pageSize[0], pgH = pageSize[1];
        if (orientation === 'landscape') [pgW, pgH] = [pgH, pgW];

        const page = mergedPdf.addPage([pgW, pgH]);
        const fitScale = Math.min(pgW / imgW, pgH / imgH);
        const drawW = imgW * fitScale;
        const drawH = imgH * fitScale;
        page.drawImage(embeddedImg, {
          x: (pgW - drawW) / 2,
          y: (pgH - drawH) / 2,
          width: drawW,
          height: drawH
        });
        totalPages++;
        setProgress(baseProgress + sliceSize, `Embedded "${entry.name}"`);
        await tick();
      }
    }

    setProgress(92, 'Serializing PDF with stream compression…');
    await tick();

    // ── STREAM COMPRESSION via useObjectStreams ──────────────────────────────
    // pdf-lib's useObjectStreams packs indirect objects into compressed ObjStm
    // streams using Flate (zlib deflate). This is analogous to PDF 1.5+
    // cross-reference streams and typically saves 10–25% on structure overhead.
    // addDefaultPage: false prevents inserting a blank page when no pages exist.
    const pdfBytes = await mergedPdf.save({
      useObjectStreams: true,    // Flate-compress object streams (PDF 1.5+)
      addDefaultPage: false,
    });

    setProgress(100, 'Done!');
    await tick();

    // ── Output ────────────────────────────────────────────────────────────────
    const outName = document.getElementById('output-name').value.trim() || 'merged-document.pdf';
    const finalName = outName.endsWith('.pdf') ? outName : outName + '.pdf';

    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);

    // Stats
    document.getElementById('stat-files').textContent = files.length;
    document.getElementById('stat-pages').textContent = totalPages;
    document.getElementById('stat-size').textContent = formatSize(blob.size);

    // Compression report
    const savedBytes = totalInputBytes - blob.size;
    const savedPct = totalInputBytes > 0 ? Math.round((savedBytes / totalInputBytes) * 100) : 0;
    const ratio = totalInputBytes > 0 ? (totalInputBytes / blob.size).toFixed(2) : '1.00';

    document.getElementById('rep-original').textContent = formatSize(totalInputBytes);
    document.getElementById('rep-final').textContent = formatSize(blob.size);

    const savedEl = document.getElementById('rep-saved');
    if (savedBytes > 0) {
      savedEl.textContent = `${formatSize(savedBytes)} (${savedPct}%)`;
      savedEl.className = 'report-val green';
    } else {
      savedEl.textContent = `+${formatSize(Math.abs(savedBytes))} (overhead)`;
      savedEl.className = 'report-val amber';
    }

    document.getElementById('rep-ratio').textContent = `${ratio}× smaller`;
    document.getElementById('rep-ratio').className = savedBytes > 0 ? 'report-val green' : 'report-val amber';
    document.getElementById('rep-strategy').textContent = cfg.label;

    const barPct = Math.max(0, Math.min(100, savedPct));
    setTimeout(() => {
      document.getElementById('savings-bar-fill').style.width = barPct + '%';
    }, 100);
    document.getElementById('savings-bar-label').textContent = `${barPct}% savings`;

    document.getElementById('compression-report').classList.add('visible');

    const link = document.getElementById('download-link');
    link.href = url;
    link.download = finalName;

    document.getElementById('success-panel').classList.add('visible');
    document.getElementById('success-panel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    link.click();

  } catch(e) {
    hideProgress();
    alert('Error during merge: ' + e.message);
  } finally {
    setTimeout(hideProgress, 1200);
    btn.classList.remove('loading');
    btn.innerHTML = `<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-3"/><polyline points="8 6 12 2 16 6"/><line x1="12" y1="2" x2="12" y2="13"/></svg> Merge & Download PDF`;
  }
}

// Yield to event loop (allows UI updates mid-async)
function tick() { return new Promise(r => setTimeout(r, 16)); }

function getPageSize() {
  const sel = document.getElementById('page-size').value;
  // pdf-lib uses points (1mm ≈ 2.8346 pt)
  const mm2pt = v => v * 2.8346;
  const sizes = {
    A4: [mm2pt(210), mm2pt(297)],
    Letter: [mm2pt(215.9), mm2pt(279.4)],
    Legal: [mm2pt(215.9), mm2pt(355.6)],
  };
  if (sel === 'Custom') {
    const w = parseFloat(document.getElementById('custom-w').value) || 210;
    const h = parseFloat(document.getElementById('custom-h').value) || 297;
    return [mm2pt(w), mm2pt(h)];
  }
  return sizes[sel] || sizes.A4;
}
</script>
<!-- ══ PASSWORD MODAL ════════════════════════════════════════ -->
<div id="pw-modal-root">
  <!-- Backdrop -->
  <div class="pw-modal-backdrop" onclick="closePwModal()"></div>

  <!-- Modal shell -->
  <div id="pw-modal-inner" class="pw-modal state-locked" style="position:relative;z-index:1;">

    <!-- Top color bar -->
    <div class="pw-modal-bar"></div>

    <div class="pw-modal-inner">

      <!-- Big animated lock -->
      <div class="pw-modal-lock-wrap">
        <div class="pw-modal-lock-ring">
          <svg class="pw-modal-lock-svg" viewBox="0 0 24 24" fill="none">
            <path class="modal-lock-shackle" d="M8 11V7a4 4 0 0 1 8 0v4"
              stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            <rect class="modal-lock-body" x="5" y="11" width="14" height="10" rx="2"
              stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle class="modal-lock-keyhole" cx="12" cy="16" r="1.5"/>
          </svg>
        </div>
        <div>
          <div class="pw-modal-title" id="pw-modal-title">PDF is Locked</div>
          <div class="pw-modal-sub" id="pw-modal-sub">Enter the password to include this file in the merge.</div>
        </div>
      </div>

      <!-- File name chip -->
      <div class="pw-modal-filename">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        <span id="pw-modal-fname">document.pdf</span>
      </div>

      <!-- Password input -->
      <div class="pw-modal-input-wrap">
        <input
          type="password"
          id="pw-modal-input"
          class="pw-modal-input"
          placeholder="Enter PDF password…"
          autocomplete="off"
          spellcheck="false"
          oninput="onPwModalInput(this.value)"
        >
        <button class="pw-modal-eye" id="pw-modal-eye-btn" type="button" onclick="toggleModalEye()" title="Show/hide password">
          <svg class="pw-eye-open" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          <svg class="pw-eye-shut" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
        </button>
      </div>

      <!-- Strength dots -->
      <div class="pw-modal-dots" id="pw-modal-dots">
        <div class="pw-modal-dot"></div>
        <div class="pw-modal-dot"></div>
        <div class="pw-modal-dot"></div>
        <div class="pw-modal-dot"></div>
      </div>

      <!-- Status line -->
      <div class="pw-modal-status" id="pw-modal-status"></div>

      <!-- Action buttons -->
      <div class="pw-modal-actions">
        <button class="btn-pw-cancel" onclick="closePwModal()">Cancel</button>
        <button class="btn-pw-unlock" id="btn-pw-unlock" onclick="verifyPwAndUnlock()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M8 11V7a4 4 0 0 1 8 0v4"/><rect x="5" y="11" width="14" height="10" rx="2"/></svg>
          Unlock PDF
        </button>
      </div>

    </div>
  </div>
</div>

<!-- ══ REORDER MODAL ═════════════════════════════════════════════════════ -->
<div id="reorder-modal">
  <div class="reorder-shell">
    <div class="reorder-header">
      <div class="card-icon ink" style="width:28px;height:28px;border-radius:7px;">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </div>
      <span class="reorder-title">Bulk Reorder Files</span>
      <button class="btn-cam-close" style="width:28px;height:28px;background:rgba(26,26,46,0.05);border-color:var(--border);color:var(--ink-muted);" onclick="closeReorderModal()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="reorder-body">
      <p>Edit the numbers at the start of each line to set a new order, or rearrange lines by cut &amp; paste. One file per line. Click <strong>Apply Order</strong> when done.</p>
      <textarea class="reorder-textarea" id="reorder-textarea" spellcheck="false"></textarea>
      <div class="reorder-error" id="reorder-error"></div>
    </div>
    <div class="reorder-footer">
      <button class="btn-reorder-cancel" onclick="closeReorderModal()">Cancel</button>
      <button class="btn-reorder-apply" onclick="applyReorderModal()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px;vertical-align:middle;"><polyline points="20 6 9 17 4 12"/></svg>
        Apply Order
      </button>
    </div>
  </div>
</div>

<!-- ══ CAMERA MODAL ══════════════════════════════════════════════════════ -->
<div id="camera-modal">
  <div class="camera-shell">

    <!-- Top bar -->
    <div class="camera-topbar">
      <div class="camera-topbar-title">
        <div class="cam-live-dot" id="cam-live-dot"></div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        Scan Document
      </div>
      <button class="btn-cam-close" onclick="closeCamera()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>

    <!-- Viewfinder -->
    <div class="viewfinder-wrap">
      <video id="cam-video" autoplay playsinline muted></video>
      <div class="cam-overlay">
        <div class="cam-corner tl"></div>
        <div class="cam-corner tr"></div>
        <div class="cam-corner bl"></div>
        <div class="cam-corner br"></div>
        <div class="cam-guide-line-h"></div>
        <div class="cam-guide-line-v"></div>
      </div>
      <div class="cam-flash" id="cam-flash"></div>
      <div id="cam-error">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        <span id="cam-error-msg">Camera not available.<br>Please allow camera access and try again.</span>
        <button class="btn-select" style="margin-top:8px" onclick="startCamera()">Try Again</button>
      </div>
    </div>

    <!-- Enhancement toggle -->
    <div class="cam-enhance-row">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      <span class="cam-enhance-label">Document enhancement (auto-contrast & sharpen)</span>
      <button class="cam-toggle on" id="cam-enhance-toggle" onclick="toggleEnhance()"></button>
    </div>

    <!-- Capture controls -->
    <div class="camera-controls">
      <button class="btn-cam-flip" onclick="flipCamera()" title="Flip camera">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
      </button>
      <button class="btn-cam-shoot" onclick="captureShot()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="4" fill="currentColor"/></svg>
        Capture
      </button>
      <div class="cam-shot-count" id="cam-shot-count">0 shots</div>
    </div>

    <!-- Thumbnails strip -->
    <div class="cam-thumbs-wrap" id="cam-thumbs-wrap">
      <div class="cam-thumbs-label">Captured pages — drag to reorder before adding</div>
      <div class="cam-thumbs-row" id="cam-thumbs-row"></div>
    </div>

    <!-- Footer actions -->
    <div class="cam-footer">
      <button class="btn-cam-add" id="btn-cam-add" disabled onclick="addCapturedToQueue()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Add <span id="cam-add-label">0 pages</span> to Queue
      </button>
      <button class="btn-cam-clear" onclick="clearShots()">Clear All</button>
    </div>

  </div>
</div>

<!-- Hidden canvas used for frame capture & enhancement -->
<canvas id="cam-canvas" style="display:none"></canvas>

<script>
// ─── Camera Module ────────────────────────────────────────────────────────────

let camStream = null;
let camFacingMode = 'environment'; // prefer rear camera for document scanning
let camEnhance = true;
let capturedShots = []; // array of { dataUrl, blob }
let camDragSrc = null;

// DOM refs — resolved lazily after DOMContentLoaded
let camVideo, camCanvas, camFlash, camError, camErrorMsg;
let camThumbsW, camThumbsR, camShotCnt, btnCamAdd, camAddLbl, camLiveDot;

document.addEventListener('DOMContentLoaded', () => {
  camVideo    = document.getElementById('cam-video');
  camCanvas   = document.getElementById('cam-canvas');
  camFlash    = document.getElementById('cam-flash');
  camError    = document.getElementById('cam-error');
  camErrorMsg = document.getElementById('cam-error-msg');
  camThumbsW  = document.getElementById('cam-thumbs-wrap');
  camThumbsR  = document.getElementById('cam-thumbs-row');
  camShotCnt  = document.getElementById('cam-shot-count');
  btnCamAdd   = document.getElementById('btn-cam-add');
  camAddLbl   = document.getElementById('cam-add-label');
  camLiveDot  = document.getElementById('cam-live-dot');

  const cameraModal = document.getElementById('camera-modal');
  if (cameraModal) {
    cameraModal.addEventListener('click', e => {
      if (e.target === cameraModal) closeCamera();
    });
  }

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      if (document.getElementById('pw-modal-root')?.classList.contains('open')) { closePwModal(); return; }
      if (document.getElementById('camera-modal')?.classList.contains('open')) closeCamera();
      if (document.getElementById('reorder-modal')?.classList.contains('open')) closeReorderModal();
    }
  });
});

// ── Open / Close ─────────────────────────────────────────────────────────────

function openCamera() {
  document.getElementById('camera-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  startCamera();
}

function closeCamera() {
  stopCamera();
  document.getElementById('camera-modal').classList.remove('open');
  document.body.style.overflow = '';
}

// ── Camera Stream ─────────────────────────────────────────────────────────────

async function startCamera() {
  camError.classList.remove('visible');
  camLiveDot.style.background = '#f59e0b'; // amber while starting

  try {
    if (camStream) { camStream.getTracks().forEach(t => t.stop()); }

    const constraints = {
      video: {
        facingMode: { ideal: camFacingMode },
        width:  { ideal: 1920 },
        height: { ideal: 1080 },
      }
    };

    camStream = await navigator.mediaDevices.getUserMedia(constraints);
    camVideo.srcObject = camStream;
    await camVideo.play();
    camLiveDot.style.background = '#ef4444'; // red = live
    camError.classList.remove('visible');
  } catch(err) {
    camLiveDot.style.background = '#6b7280';
    camError.classList.add('visible');
    if (err.name === 'NotAllowedError') {
      camErrorMsg.innerHTML = 'Camera access denied.<br>Please allow camera permission in your browser settings.';
    } else if (err.name === 'NotFoundError') {
      camErrorMsg.innerHTML = 'No camera found.<br>Please connect a camera and try again.';
    } else {
      camErrorMsg.innerHTML = `Camera error: ${err.message}`;
    }
  }
}

function stopCamera() {
  if (camStream) {
    camStream.getTracks().forEach(t => t.stop());
    camStream = null;
  }
  camVideo.srcObject = null;
}

async function flipCamera() {
  camFacingMode = camFacingMode === 'environment' ? 'user' : 'environment';
  await startCamera();
}

// ── Enhancement ───────────────────────────────────────────────────────────────
// Applies document-optimized processing to the canvas:
// 1. Contrast stretching  — maps the darkest 5% to black, brightest 5% to white
// 2. Simple unsharp mask  — sharpens edges using a 3×3 Laplacian approximation
// 3. Slight warm tone     — yellowy paper tone removed toward neutral white

function applyDocumentEnhancement(ctx, width, height) {
  const imageData = ctx.getImageData(0, 0, width, height);
  const data = imageData.data;
  const len = data.length;

  // ── Step 1: Auto-levels (contrast stretch) ────────────────────────────────
  let minL = 255, maxL = 0;
  for (let i = 0; i < len; i += 4) {
    const lum = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
    if (lum < minL) minL = lum;
    if (lum > maxL) maxL = lum;
  }
  // Clip 2% at each end to ignore specular highlights and deep shadows
  const range = Math.max(1, maxL - minL);
  const clipLow  = minL + range * 0.02;
  const clipHigh = maxL - range * 0.02;
  const scaleRange = Math.max(1, clipHigh - clipLow);

  for (let i = 0; i < len; i += 4) {
    data[i]   = Math.min(255, Math.max(0, Math.round((data[i]   - clipLow) / scaleRange * 255)));
    data[i+1] = Math.min(255, Math.max(0, Math.round((data[i+1] - clipLow) / scaleRange * 255)));
    data[i+2] = Math.min(255, Math.max(0, Math.round((data[i+2] - clipLow) / scaleRange * 255)));
  }

  // ── Step 2: Slight desaturation of warm tones (paper whitening) ───────────
  for (let i = 0; i < len; i += 4) {
    const r = data[i], g = data[i+1], b = data[i+2];
    // Move warm pixels (r > g > b) slightly toward grey
    if (r > 200 && g > 180 && b < g) {
      const grey = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
      data[i]   = Math.min(255, Math.round(r + (grey - r) * 0.4));
      data[i+1] = Math.min(255, Math.round(g + (grey - g) * 0.25));
      data[i+2] = Math.min(255, Math.round(b + (grey - b) * 0.1));
    }
  }

  ctx.putImageData(imageData, 0, 0);

  // ── Step 3: CSS filter sharpening (cheap unsharp mask via filter API) ─────
  // We draw onto a temporary canvas with contrast boost then composite back
  const tmp = document.createElement('canvas');
  tmp.width = width; tmp.height = height;
  const tmpCtx = tmp.getContext('2d');
  tmpCtx.filter = 'contrast(1.08) brightness(1.04)';
  tmpCtx.drawImage(camCanvas, 0, 0);
  ctx.drawImage(tmp, 0, 0);
}

// ── Capture ───────────────────────────────────────────────────────────────────

async function captureShot() {
  if (!camStream) return;

  const w = camVideo.videoWidth  || 1280;
  const h = camVideo.videoHeight || 720;
  camCanvas.width  = w;
  camCanvas.height = h;

  const ctx = camCanvas.getContext('2d');
  ctx.drawImage(camVideo, 0, 0, w, h);

  if (camEnhance) {
    applyDocumentEnhancement(ctx, w, h);
  }

  // Flash animation
  camFlash.classList.add('flash');
  setTimeout(() => camFlash.classList.remove('flash'), 120);

  // Get blob
  const blob = await new Promise(res => camCanvas.toBlob(res, 'image/jpeg', 0.92));
  const dataUrl = camCanvas.toDataURL('image/jpeg', 0.92);

  capturedShots.push({ dataUrl, blob, id: Date.now() + Math.random() });
  renderCamThumbs();
}

// ── Thumbnails ────────────────────────────────────────────────────────────────

function renderCamThumbs() {
  const n = capturedShots.length;
  camThumbsW.classList.toggle('visible', n > 0);
  camShotCnt.textContent  = n === 0 ? '0 shots' : `${n} shot${n > 1 ? 's' : ''}`;
  camShotCnt.classList.toggle('has-shots', n > 0);
  camAddLbl.textContent   = `${n} page${n !== 1 ? 's' : ''}`;
  btnCamAdd.disabled      = n === 0;

  camThumbsR.innerHTML = '';
  capturedShots.forEach((shot, idx) => {
    const el = document.createElement('div');
    el.className = 'cam-thumb';
    el.draggable = true;
    el.dataset.id = shot.id;
    el.innerHTML = `
      <img src="${shot.dataUrl}" alt="Page ${idx + 1}">
      <span class="cam-thumb-num">${idx + 1}</span>
      <button class="cam-thumb-del" onclick="deleteShot('${shot.id}', event)">✕</button>
    `;
    // Drag-to-reorder within thumbnails
    el.addEventListener('dragstart', e => { camDragSrc = shot.id; e.dataTransfer.effectAllowed = 'move'; });
    el.addEventListener('dragover',  e => { e.preventDefault(); el.style.opacity = '0.5'; });
    el.addEventListener('dragleave', () => { el.style.opacity = '1'; });
    el.addEventListener('drop', e => {
      e.preventDefault(); el.style.opacity = '1';
      if (camDragSrc && camDragSrc !== shot.id) {
        const fromIdx = capturedShots.findIndex(s => String(s.id) === String(camDragSrc));
        const toIdx   = capturedShots.findIndex(s => String(s.id) === String(shot.id));
        const [moved] = capturedShots.splice(fromIdx, 1);
        capturedShots.splice(toIdx, 0, moved);
        renderCamThumbs();
      }
    });
    el.addEventListener('dragend', () => el.style.opacity = '1');
    camThumbsR.appendChild(el);
  });
}

function deleteShot(id, e) {
  e.stopPropagation();
  capturedShots = capturedShots.filter(s => String(s.id) !== String(id));
  renderCamThumbs();
}

function clearShots() {
  capturedShots = [];
  renderCamThumbs();
}

function toggleEnhance() {
  camEnhance = !camEnhance;
  document.getElementById('cam-enhance-toggle').classList.toggle('on', camEnhance);
}

// ── Add captured shots to main file queue ────────────────────────────────────

async function addCapturedToQueue() {
  if (capturedShots.length === 0) return;

  for (let i = 0; i < capturedShots.length; i++) {
    const shot = capturedShots[i];
    const name = `camera-scan-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}-p${i+1}.jpg`;
    const file = new File([shot.blob], name, { type: 'image/jpeg' });
    const entry = {
      id: shot.id,
      file,
      name,
      size: shot.blob.size,
      type: 'img',
      pageCount: null,
      password: '',
      pwError: false,
      isEncrypted: false,
      isCameraShot: true
    };
    files.push(entry);
  }

  renderList();
  closeCamera();

  // Clear shots after adding
  capturedShots = [];
  renderCamThumbs();
}
</script>

</body>
</html>